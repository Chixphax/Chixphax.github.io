<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D&amp;D 5.5 Sorcerer Character Sheet</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&amp;family=Crimson+Text:ital,wght@0,400;0,600;1,400&amp;display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #1a1625;
      --bg-secondary: #252033;
      --text-primary: #e8e4f0;
      --accent-primary: #9d4edd;
      --accent-secondary: #c77dff;
    }
    
    * { box-sizing: border-box; }
    
    body {
      font-family: 'Crimson Text', Georgia, serif;
      background: var(--bg-primary);
      color: var(--text-primary);
    }
    
    .font-title { font-family: 'Cinzel', serif; }
    
    .magic-gradient {
      background: linear-gradient(135deg, #9d4edd 0%, #7b2cbf 50%, #5a189a 100%);
    }
    
    .card {
      background: var(--bg-secondary);
      border: 1px solid rgba(157, 78, 221, 0.3);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(157, 78, 221, 0.15);
    }
    
    .input-field {
      background: rgba(26, 22, 37, 0.8);
      border: 1px solid rgba(157, 78, 221, 0.4);
      color: var(--text-primary);
      border-radius: 6px;
      padding: 6px 10px;
      transition: all 0.2s;
    }
    
    .input-field:focus {
      outline: none;
      border-color: var(--accent-secondary);
      box-shadow: 0 0 10px rgba(199, 125, 255, 0.3);
    }
    
    .input-field::placeholder { color: rgba(232, 228, 240, 0.4); }
    
    .stat-box {
      background: linear-gradient(180deg, rgba(37, 32, 51, 0.9) 0%, rgba(26, 22, 37, 0.9) 100%);
      border: 2px solid rgba(157, 78, 221, 0.5);
      border-radius: 12px;
      position: relative;
    }
    
    .stat-box::before {
      content: '';
      position: absolute;
      top: -1px;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
    }
    
    .spell-slot {
      width: 24px;
      height: 24px;
      border: 2px solid var(--accent-primary);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .spell-slot.used {
      background: var(--accent-primary);
      box-shadow: 0 0 8px var(--accent-secondary);
    }
    
    .spell-slot:hover { transform: scale(1.1); }
    
    .checkbox-skill {
      width: 14px;
      height: 14px;
      border: 2px solid var(--accent-primary);
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .checkbox-skill.checked {
      background: var(--accent-primary);
    }
    
    .checkbox-skill.expertise {
      background: var(--accent-secondary);
      border-color: var(--accent-secondary);
    }
    
    .tab-btn {
      padding: 8px 16px;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    
    .tab-btn.active {
      background: var(--bg-secondary);
      border-color: rgba(157, 78, 221, 0.5);
      border-bottom-color: var(--bg-secondary);
      color: var(--accent-secondary);
    }
    
    .tab-btn:not(.active):hover {
      background: rgba(157, 78, 221, 0.1);
    }
    
    .sorcery-point {
      width: 20px;
      height: 20px;
      background: rgba(157, 78, 221, 0.2);
      border: 2px solid var(--accent-primary);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .sorcery-point.used {
      background: var(--accent-primary);
      box-shadow: 0 0 6px var(--accent-secondary);
    }
    
    .metamagic-tag {
      background: rgba(157, 78, 221, 0.2);
      border: 1px solid var(--accent-primary);
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .metamagic-tag.active {
      background: var(--accent-primary);
      color: white;
    }
    
    .metamagic-tag:hover { transform: translateY(-1px); }
    
    .concentration-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(255, 183, 77, 0.2);
      border: 1px solid #ffb74d;
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 0.75rem;
      color: #ffb74d;
    }
    
    .action-badge {
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      font-weight: 600;
    }
    
    .action-badge.action { background: rgba(76, 175, 80, 0.3); color: #81c784; }
    .action-badge.bonus { background: rgba(255, 152, 0, 0.3); color: #ffb74d; }
    .action-badge.reaction { background: rgba(244, 67, 54, 0.3); color: #e57373; }
    
    .scroll-container {
      scrollbar-width: thin;
      scrollbar-color: var(--accent-primary) var(--bg-primary);
    }
    
    .scroll-container::-webkit-scrollbar { width: 6px; }
    .scroll-container::-webkit-scrollbar-track { background: var(--bg-primary); }
    .scroll-container::-webkit-scrollbar-thumb { 
      background: var(--accent-primary);
      border-radius: 3px;
    }
    
    .glow-text {
      text-shadow: 0 0 10px rgba(199, 125, 255, 0.5);
    }

    .death-save-dot {
      width: 14px;
      height: 14px;
      border-radius: 9999px;
      border: 2px solid rgba(129, 199, 132, 0.8);
      background: transparent;
      cursor: pointer;
      transition: all 0.15s;
    }

    .death-save-dot.success {
      background: #81c784;
      box-shadow: 0 0 6px rgba(129, 199, 132, 0.9);
    }

    .death-save-dot.failure {
      border-color: rgba(239, 83, 80, 0.9);
      background: #ef5350;
      box-shadow: 0 0 6px rgba(239, 83, 80, 0.9);
    }

    .inspiration-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 9999px;
      border: 1px solid rgba(199, 125, 255, 0.7);
      background: rgba(157, 78, 221, 0.12);
      color: var(--accent-secondary);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .inspiration-toggle:hover {
      background: rgba(199, 125, 255, 0.3);
      box-shadow: 0 0 8px rgba(199, 125, 255, 0.4);
    }

    .inspiration-toggle-dot {
      width: 10px;
      height: 10px;
      border-radius: 9999px;
      border: 2px solid var(--accent-secondary);
      background: transparent;
      box-shadow: none;
      transition: all 0.2s;
    }

    .inspiration-toggle.active {
      background: linear-gradient(135deg, #ffc107 0%, #ffb74d 40%, #ff8a65 100%);
      color: #1a1625;
      box-shadow: 0 0 12px rgba(255, 183, 77, 0.7);
      border-color: rgba(255, 244, 214, 0.9);
    }

    .inspiration-toggle.active .inspiration-toggle-dot {
      background: #ffe082;
      border-color: #ffca28;
      box-shadow: 0 0 8px rgba(255, 236, 179, 0.9);
    }
    
    @media print {
      body { background: white; color: #1a1625; }
      .card { border: 1px solid #9d4edd; box-shadow: none; }
      .no-print { display: none; }
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="h-full overflow-auto scroll-container">
   <div class="max-w-7xl mx-auto p-4">
    <!-- Header -->
    <header class="mb-4">
     <div class="flex items-center justify-between flex-wrap gap-4">
      <div class="flex items-center gap-3">
       <div class="w-12 h-12 magic-gradient rounded-xl flex items-center justify-center">
        <svg class="w-7 h-7 text-white" fill="currentColor" viewbox="0 0 24 24">
         <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" />
        </svg>
       </div>
       <div>
        <h1 id="sheet-title" class="font-title text-2xl font-bold glow-text" style="color: var(--accent-secondary);">Hechicero D&amp;D 5.5</h1>
        <p class="text-sm opacity-70">Hoja de Personaje Interactiva</p>
       </div>
      </div>
      <div class="flex gap-2 no-print">
       <button onclick="saveCharacter()" class="px-4 py-2 magic-gradient rounded-lg text-white font-semibold text-sm hover:opacity-90 transition flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
        </svg> Guardar </button>
       <button onclick="updateBookmark()" class="px-4 py-2 border border-yellow-500/60 rounded-lg text-sm hover:bg-yellow-500/10 transition" title="Actualiza la URL con tu personaje ‚Äî gu√°rdala como marcador en iOS">üìå Marcador iOS</button>
       <button onclick="exportCharacter()" class="px-4 py-2 border border-purple-500/50 rounded-lg text-sm hover:bg-purple-500/10 transition" title="Exportar personaje como archivo JSON">üì§ Exportar</button>
       <label class="px-4 py-2 border border-purple-500/50 rounded-lg text-sm hover:bg-purple-500/10 transition cursor-pointer" title="Importar personaje desde archivo JSON">üì• Importar<input type="file" accept=".json" class="hidden" onchange="importCharacter(event)"></label>
       <button onclick="window.print()" class="px-4 py-2 border border-purple-500/50 rounded-lg text-sm hover:bg-purple-500/10 transition"> üñ®Ô∏è Imprimir </button>
      </div>
     </div>
    </header><!-- Navigation Tabs -->
    <nav class="flex gap-1 mb-4 no-print overflow-x-auto">
     <button class="tab-btn active font-title text-sm" data-tab="character" onclick="switchTab('character')">üìú Personaje</button> <button class="tab-btn font-title text-sm" data-tab="combat" onclick="switchTab('combat')">‚öîÔ∏è Combate</button> <button class="tab-btn font-title text-sm" data-tab="spells" onclick="switchTab('spells')">‚ú® Hechizos</button> <button class="tab-btn font-title text-sm" data-tab="resources" onclick="switchTab('resources')">üíé Recursos</button> <button class="tab-btn font-title text-sm" data-tab="notes" onclick="switchTab('notes')">üìù Notas</button>
    </nav><!-- Tab Content -->
    <main id="tab-content">
     <!-- Character Tab -->
     <section id="tab-character" class="tab-panel">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
       <!-- Basic Info -->
       <div class="lg:col-span-2 card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>üë§</span> Informaci√≥n B√°sica</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
         <div class="col-span-2 md:col-span-1">
          <label class="text-xs opacity-70 block mb-1">Nombre del Personaje</label>
          <input
            type="text"
            id="char-name"
            class="input-field w-full text-lg"
            placeholder="Nombre..."
            onchange="updateCharacterInfo()"
          >
         </div>
         <div>
          <label class="text-xs opacity-70 block mb-1">Clase</label> <input type="text" id="char-class" class="input-field w-full" value="Hechicero" onchange="updateCharacterInfo()">
         </div>
         <div>
          <label class="text-xs opacity-70 block mb-1">Nivel</label> <input type="number" id="char-level" class="input-field w-full text-center text-xl font-bold" value="1" min="1" max="20" onchange="updateLevel()">
         </div>
         <div>
          <label class="text-xs opacity-70 block mb-1">Raza</label> <input type="text" id="char-race" class="input-field w-full" placeholder="Raza..." onchange="updateCharacterInfo()">
         </div>
         <div>
          <label class="text-xs opacity-70 block mb-1">Trasfondo</label> <input type="text" id="char-background" class="input-field w-full" placeholder="Trasfondo..." onchange="updateCharacterInfo()">
         </div>
         <div>
          <label class="text-xs opacity-70 block mb-1">Alineamiento</label> <select id="char-alignment" class="input-field w-full" onchange="updateCharacterInfo()"> <option value="">Seleccionar...</option> <option value="LB">Legal Bueno</option> <option value="NB">Neutral Bueno</option> <option value="CB">Ca√≥tico Bueno</option> <option value="LN">Legal Neutral</option> <option value="N">Neutral</option> <option value="CN">Ca√≥tico Neutral</option> <option value="LM">Legal Malvado</option> <option value="NM">Neutral Malvado</option> <option value="CM">Ca√≥tico Malvado</option> </select>
         </div>
        </div><!-- Subclass -->
        <div class="mt-4 p-3 rounded-lg" style="background: rgba(157, 78, 221, 0.1);">
         <label class="text-xs opacity-70 block mb-1">Origen M√°gico (Subclase)</label> <select id="char-subclass" class="input-field w-full" onchange="updateSubclass()"> <option value="">Seleccionar origen...</option> <option value="draconic">Linaje Drac√≥nico</option> <option value="wild">Magia Salvaje</option> <option value="divine">Alma Divina</option> <option value="shadow">Magia de Sombras</option> <option value="storm">Alma de Tormenta</option> <option value="aberrant">Mente Aberrante</option> <option value="clockwork">Alma Mec√°nica</option> <option value="lunar">Hechicer√≠a Lunar</option> </select>
         <div id="subclass-features" class="mt-2 text-sm opacity-80"></div>
        </div>
       </div><!-- Combat Stats -->
       <div class="card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>üõ°Ô∏è</span> Estad√≠sticas Vitales</h2>
        <div class="grid grid-cols-3 gap-3 mb-4">
         <div class="stat-box p-3 text-center">
          <div class="text-xs opacity-70 mb-1">
           CA
          </div><input type="number" id="stat-ac" class="input-field w-full text-center text-2xl font-bold" value="10" onchange="updateCharacterInfo()">
         </div>
         <div class="stat-box p-3 text-center">
          <div class="text-xs opacity-70 mb-1">
           Iniciativa
          </div>
          <div id="stat-initiative" class="text-2xl font-bold" style="color: var(--accent-secondary);">
           +0
          </div>
         </div>
         <div class="stat-box p-3 text-center">
          <div class="text-xs opacity-70 mb-1">
           Velocidad
          </div><input type="text" id="stat-speed" class="input-field w-full text-center text-lg font-bold" value="30 pies" onchange="updateCharacterInfo()">
         </div>
        </div><!-- Hit Points -->
        <div class="stat-box p-4">
         <div class="text-center mb-2">
          <span class="text-xs opacity-70">Puntos de Golpe</span>
         </div>
         <div class="flex items-center justify-center gap-2 mb-3">
          <input type="number" id="hp-current" class="input-field w-16 text-center text-2xl font-bold" value="6" style="color: #81c784;" onchange="updateHealthBar()"> <span class="text-xl opacity-50">/</span> <input type="number" id="hp-max" class="input-field w-16 text-center text-2xl font-bold" value="6" onchange="updateHealthBar()">
         </div><!-- Health Bar -->
         <div class="w-full h-6 rounded-lg overflow-hidden mb-2" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(129, 199, 132, 0.5);">
          <div id="health-bar" class="h-full transition-all" style="background: linear-gradient(90deg, #81c784 0%, #66bb6a 100%); width: 100%;"></div>
         </div>
         <div class="flex items-center justify-center gap-2">
          <span class="text-xs opacity-70">Temporales:</span> <input type="number" id="hp-temp" class="input-field w-16 text-center" value="0" style="color: #64b5f6;">
         </div>
        </div>
        <!-- Death Saves -->
        <div class="mt-4 stat-box p-4">
         <div class="flex items-center justify-between mb-2">
          <span class="text-xs opacity-70">Tiradas de salvaci√≥n contra la muerte (D&D 5.5)</span>
          <button type="button" class="no-print text-[0.6rem] px-2 py-0.5 rounded-full border border-purple-500/50 opacity-70 hover:opacity-100" onclick="resetDeathSaves()">Reiniciar</button>
         </div>
         <div class="flex items-center justify-between gap-3 text-xs">
          <div class="flex items-center gap-1">
           <span class="opacity-70 mr-1">√âxitos</span>
           <div id="death-success-dots" class="flex items-center gap-1">
            <div class="death-save-dot" data-index="0" onclick="toggleDeathSave('success', 0)"></div>
            <div class="death-save-dot" data-index="1" onclick="toggleDeathSave('success', 1)"></div>
            <div class="death-save-dot" data-index="2" onclick="toggleDeathSave('success', 2)"></div>
           </div>
          </div>
          <div class="flex items-center gap-1">
           <span class="opacity-70 mr-1">Fallos</span>
           <div id="death-failure-dots" class="flex items-center gap-1">
            <div class="death-save-dot" data-index="0" onclick="toggleDeathSave('failure', 0)"></div>
            <div class="death-save-dot" data-index="1" onclick="toggleDeathSave('failure', 1)"></div>
            <div class="death-save-dot" data-index="2" onclick="toggleDeathSave('failure', 2)"></div>
           </div>
          </div>
         </div>
        </div><!-- Proficiency Bonus + Inspiraci√≥n -->
        <div class="mt-4 grid grid-cols-2 gap-3">
         <div class="stat-box p-3 text-center">
          <div class="text-xs opacity-70 mb-1">
           Bonificador de Competencia
          </div>
          <div id="proficiency-bonus" class="text-3xl font-bold" style="color: var(--accent-secondary);">
           +2
          </div>
         </div>
         <div class="stat-box p-3 text-center">
          <div class="text-xs opacity-70 mb-2 flex items-center justify-center gap-1">
           <span>Inspiraci√≥n</span>
           <span class="text-yellow-300">‚òÖ</span>
          </div>
          <div class="flex items-center justify-center">
           <button type="button" id="inspiration-toggle" class="inspiration-toggle no-print" onclick="toggleInspiration()">
            <span class="inspiration-toggle-dot"></span>
            <span>Inspiracion</span>
           </button>
          </div>
         </div>
        </div>
       </div><!-- Attributes -->
       <div class="lg:col-span-2 card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>üìä</span> Atributos</h2>
        <div class="grid grid-cols-3 md:grid-cols-6 gap-3">
         <div class="stat-box p-3 text-center" data-attr="str">
          <div class="text-xs font-bold mb-1" style="color: var(--accent-primary);">
           FUE
          </div><input type="number" class="attr-score input-field w-full text-center text-xl font-bold mb-1" value="8" min="1" max="30" onchange="calculateModifiers()">
          <div class="attr-mod text-lg" style="color: var(--accent-secondary);">
           -1
          </div>
         </div>
         <div class="stat-box p-3 text-center" data-attr="dex">
          <div class="text-xs font-bold mb-1" style="color: var(--accent-primary);">
           DES
          </div><input type="number" class="attr-score input-field w-full text-center text-xl font-bold mb-1" value="14" min="1" max="30" onchange="calculateModifiers()">
          <div class="attr-mod text-lg" style="color: var(--accent-secondary);">
           +2
          </div>
         </div>
         <div class="stat-box p-3 text-center" data-attr="con">
          <div class="text-xs font-bold mb-1" style="color: var(--accent-primary);">
           CON
          </div><input type="number" class="attr-score input-field w-full text-center text-xl font-bold mb-1" value="14" min="1" max="30" onchange="calculateModifiers()">
          <div class="attr-mod text-lg" style="color: var(--accent-secondary);">
           +2
          </div>
         </div>
         <div class="stat-box p-3 text-center" data-attr="int">
          <div class="text-xs font-bold mb-1" style="color: var(--accent-primary);">
           INT
          </div><input type="number" class="attr-score input-field w-full text-center text-xl font-bold mb-1" value="10" min="1" max="30" onchange="calculateModifiers()">
          <div class="attr-mod text-lg" style="color: var(--accent-secondary);">
           +0
          </div>
         </div>
         <div class="stat-box p-3 text-center" data-attr="wis">
          <div class="text-xs font-bold mb-1" style="color: var(--accent-primary);">
           SAB
          </div><input type="number" class="attr-score input-field w-full text-center text-xl font-bold mb-1" value="12" min="1" max="30" onchange="calculateModifiers()">
          <div class="attr-mod text-lg" style="color: var(--accent-secondary);">
           +1
          </div>
         </div>
         <div class="stat-box p-3 text-center" data-attr="cha">
          <div class="text-xs font-bold mb-1" style="color: var(--accent-primary);">
           CAR
          </div><input type="number" class="attr-score input-field w-full text-center text-xl font-bold mb-1" value="16" min="1" max="30" onchange="calculateModifiers()">
          <div class="attr-mod text-lg" style="color: var(--accent-secondary);">
           +3
          </div>
         </div>
        </div>
       </div><!-- Saving Throws & Skills -->
       <div class="card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>üéØ</span> Salvaciones</h2>
        <div class="space-y-2 text-sm" id="saving-throws">
         <div class="flex items-center gap-2">
          <div class="checkbox-skill checked" data-save="con" onclick="toggleSave(this)"></div><span class="w-8 text-right save-bonus">+4</span> <span>Constituci√≥n</span> <span class="ml-auto text-xs opacity-50">‚≠ê</span>
         </div>
         <div class="flex items-center gap-2">
          <div class="checkbox-skill checked" data-save="cha" onclick="toggleSave(this)"></div><span class="w-8 text-right save-bonus">+5</span> <span>Carisma</span> <span class="ml-auto text-xs opacity-50">‚≠ê</span>
         </div>
         <div class="flex items-center gap-2">
          <div class="checkbox-skill" data-save="str" onclick="toggleSave(this)"></div><span class="w-8 text-right save-bonus">-1</span> <span>Fuerza</span>
         </div>
         <div class="flex items-center gap-2">
          <div class="checkbox-skill" data-save="dex" onclick="toggleSave(this)"></div><span class="w-8 text-right save-bonus">+2</span> <span>Destreza</span>
         </div>
         <div class="flex items-center gap-2">
          <div class="checkbox-skill" data-save="int" onclick="toggleSave(this)"></div><span class="w-8 text-right save-bonus">+0</span> <span>Inteligencia</span>
         </div>
         <div class="flex items-center gap-2">
          <div class="checkbox-skill" data-save="wis" onclick="toggleSave(this)"></div><span class="w-8 text-right save-bonus">+1</span> <span>Sabidur√≠a</span>
         </div>
        </div>
       </div><!-- Skills -->
       <div class="lg:col-span-3 card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>üí´</span> Habilidades <span class="text-xs opacity-50 ml-2">(Clic: competencia | Doble clic: pericia)</span></h2>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3 text-sm" id="skills-list">
         <!-- Skills will be populated by JS -->
        </div>
       </div>
      </div>
     </section><!-- Combat Tab -->
     <section id="tab-combat" class="tab-panel hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
       <!-- Actions Overview -->
       <div class="lg:col-span-2 card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>‚öîÔ∏è</span> Acciones en Combate</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
         <div class="p-3 rounded-lg" style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3);">
          <div class="flex items-center gap-2 mb-2">
           <span class="action-badge action">Acci√≥n</span> <span class="font-title font-bold">Principal</span>
          </div>
          <ul class="text-sm space-y-1 opacity-80">
           <li>‚Ä¢ Lanzar un hechizo</li>
           <li>‚Ä¢ Atacar</li>
           <li>‚Ä¢ Esquivar</li>
           <li>‚Ä¢ Ayudar</li>
           <li>‚Ä¢ Esconderse</li>
           <li>‚Ä¢ Usar objeto</li>
          </ul>
         </div>
         <div class="p-3 rounded-lg" style="background: rgba(255, 152, 0, 0.1); border: 1px solid rgba(255, 152, 0, 0.3);">
          <div class="flex items-center gap-2 mb-2">
           <span class="action-badge bonus">Adicional</span> <span class="font-title font-bold">Bonus</span>
          </div>
          <ul class="text-sm space-y-1 opacity-80">
           <li>‚Ä¢ Hechizo adicional</li>
           <li>‚Ä¢ Habilidades de clase</li>
           <li>‚Ä¢ Objetos m√°gicos</li>
           <li>‚Ä¢ Acelerar (Meta.)</li>
          </ul>
         </div>
         <div class="p-3 rounded-lg" style="background: rgba(244, 67, 54, 0.1); border: 1px solid rgba(244, 67, 54, 0.3);">
          <div class="flex items-center gap-2 mb-2">
           <span class="action-badge reaction">Reacci√≥n</span> <span class="font-title font-bold">1/Ronda</span>
          </div>
          <ul class="text-sm space-y-1 opacity-80">
           <li>‚Ä¢ Ataque de oportunidad</li>
           <li>‚Ä¢ Escudo (hechizo)</li>
           <li>‚Ä¢ Contrahechizo</li>
           <li>‚Ä¢ Absorber elementos</li>
          </ul>
         </div>
        </div>
       </div><!-- Spell Attack Info -->
       <div class="card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>üéØ</span> Ataque con Hechizos</h2>
        <div class="space-y-4">
         <div class="stat-box p-4 text-center">
          <div class="text-xs opacity-70 mb-1">
           CD de Salvaci√≥n
          </div>
          <div id="spell-dc" class="text-3xl font-bold" style="color: var(--accent-secondary);">
           13
          </div>
          <div class="text-xs opacity-50 mt-1">
           8 + competencia + CAR
          </div>
         </div>
         <div class="stat-box p-4 text-center">
          <div class="text-xs opacity-70 mb-1">
           Bonificador de Ataque
          </div>
          <div id="spell-attack" class="text-3xl font-bold" style="color: var(--accent-secondary);">
           +5
          </div>
          <div class="text-xs opacity-50 mt-1">
           competencia + CAR
          </div>
         </div>
         <div class="p-3 rounded-lg text-center" style="background: rgba(157, 78, 221, 0.1);">
          <div class="text-xs opacity-70 mb-1">
           Atributo de Lanzamiento
          </div>
          <div class="text-xl font-bold" style="color: var(--accent-primary);">
           Carisma
          </div>
         </div>
        </div>
       </div><!-- Quick Spells -->
       <div class="lg:col-span-3 card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>‚ú®</span> Hechizos de Combate Frecuentes</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="combat-spells">
         <!-- Populated by JS -->
        </div><button onclick="openSpellModal()" class="mt-4 w-full py-2 border border-dashed border-purple-500/50 rounded-lg text-sm opacity-70 hover:opacity-100 hover:bg-purple-500/10 transition no-print"> + A√±adir hechizo de combate </button>
       </div>
      </div>
     </section><!-- Spells Tab -->
     <section id="tab-spells" class="tab-panel hidden">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
       <!-- Spell Slots -->
       <div class="card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>üí´</span> Espacios de Conjuro</h2>
        <div class="space-y-3" id="spell-slots-container">
         <!-- Populated by JS based on level -->
        </div>
        <div class="mt-4 pt-4 border-t border-purple-500/20">
         <button onclick="confirmLongRest()" class="w-full py-2 px-3 rounded-lg text-sm transition no-print" style="background: rgba(100, 181, 246, 0.2); border: 1px solid #64b5f6; color: #64b5f6;"> üåô Descanso Largo </button>
        </div>
       </div><!-- Spells Known -->
       <div class="lg:col-span-3 card p-4">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
         <h2 class="font-title text-lg flex items-center gap-2" style="color: var(--accent-secondary);"><span>üìñ</span> Hechizos Conocidos</h2>
         <div class="flex items-center gap-4 text-sm">
          <span class="opacity-70">Conocidos: <strong id="spells-known-count">0</strong>/<strong id="spells-known-max">2</strong></span> <span class="opacity-70">Trucos: <strong id="cantrips-count">0</strong>/<strong id="cantrips-max">4</strong></span>
         </div>
        </div><!-- Cantrips -->
        <div class="mb-4">
         <h3 class="font-title text-sm mb-2 flex items-center gap-2 opacity-80"><span style="color: var(--accent-primary);">‚ú¶</span> Trucos (a voluntad)</h3>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-2" id="cantrips-list">
          <!-- Populated by JS -->
         </div><button onclick="addSpell(0)" class="mt-2 w-full py-2 border border-dashed border-purple-500/30 rounded-lg text-xs opacity-60 hover:opacity-100 hover:bg-purple-500/10 transition no-print"> + A√±adir truco </button>
        </div><!-- Spell Levels -->
        <div class="space-y-4" id="spells-by-level">
         <!-- Populated by JS -->
        </div>
       </div>
      </div>
     </section><!-- Resources Tab -->
     <section id="tab-resources" class="tab-panel hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
       <!-- Sorcery Points -->
       <div class="card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>üíé</span> Puntos de Hechicer√≠a</h2>
        <div class="flex items-center justify-between mb-4">
         <span class="text-sm opacity-70">M√°ximo: <span id="sorcery-max">0</span> (igual al nivel)</span> <span class="text-sm">Actuales: <strong id="sorcery-current">0</strong></span>
        </div>
        <div class="flex flex-wrap gap-2 mb-4" id="sorcery-points-container">
         <!-- Populated by JS -->
        </div>
        <div class="p-3 rounded-lg mb-4" style="background: rgba(157, 78, 221, 0.1);">
         <h4 class="text-sm font-bold mb-2">Conversi√≥n de Recursos</h4>
         <div class="grid grid-cols-2 gap-2 text-xs">
          <div class="p-2 rounded" style="background: rgba(0,0,0,0.2);">
           <div class="font-bold mb-1">
            Crear Espacio
           </div>
           <div class="space-y-1 opacity-80">
            <div>
             Nv1: 2 pts
            </div>
            <div>
             Nv2: 3 pts
            </div>
            <div>
             Nv3: 5 pts
            </div>
            <div>
             Nv4: 6 pts
            </div>
            <div>
             Nv5: 7 pts
            </div>
           </div>
          </div>
          <div class="p-2 rounded" style="background: rgba(0,0,0,0.2);">
           <div class="font-bold mb-1">
            Convertir Espacio
           </div>
           <div class="space-y-1 opacity-80">
            <div>
             Nv1-5: Nv pts
            </div>
            <div class="mt-2 text-yellow-400">
             ‚ö†Ô∏è Solo hasta nivel 5
            </div>
           </div>
          </div>
         </div>
        </div>
       </div><!-- Metamagic -->
       <div class="card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>üí´</span> Metamagia <span class="text-xs opacity-50">(Nivel 2+)</span></h2>
        <p class="text-sm opacity-70 mb-3">Selecciona las opciones conocidas:</p>
        <div class="flex flex-wrap gap-2" id="metamagic-options">
         <div class="metamagic-tag" onclick="toggleMetamagic(this)" data-cost="1" data-meta="careful">
          Conjuro Cuidadoso (1)
         </div>
         <div class="metamagic-tag" onclick="toggleMetamagic(this)" data-cost="1" data-meta="distant">
          Conjuro Distante (1)
         </div>
         <div class="metamagic-tag" onclick="toggleMetamagic(this)" data-cost="1" data-meta="empowered">
          Conjuro Potenciado (1)
         </div>
         <div class="metamagic-tag" onclick="toggleMetamagic(this)" data-cost="1" data-meta="extended">
          Conjuro Extendido (1)
         </div>
         <div class="metamagic-tag" onclick="toggleMetamagic(this)" data-cost="1" data-meta="twin">
          Conjuro Gemelo (1)
         </div>
         <div class="metamagic-tag" onclick="toggleMetamagic(this)" data-cost="2" data-meta="heightened">
          Conjuro Intensificado (2)
         </div>
         <div class="metamagic-tag" onclick="toggleMetamagic(this)" data-cost="2" data-meta="quickened">
          Conjuro Acelerado (2)
         </div>
         <div class="metamagic-tag" onclick="toggleMetamagic(this)" data-cost="1" data-meta="seeking">
          Conjuro Buscador (1)
         </div>
         <div class="metamagic-tag" onclick="toggleMetamagic(this)" data-cost="1" data-meta="subtle">
          Conjuro Sutil (1)
         </div>
         <div class="metamagic-tag" onclick="toggleMetamagic(this)" data-cost="1" data-meta="transmuted">
          Conjuro Transmutado (1)
         </div>
        </div>
        <div id="metamagic-descriptions" class="mt-4 space-y-3 text-xs leading-snug opacity-90">
         <!-- Descripciones de metamagia seleccionada -->
        </div>
       </div><!-- Class Features -->
       <div class="lg:col-span-2 card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>üìú</span> Rasgos de Clase del Hechicero (D&amp;D 5.5)</h2>
        <div class="space-y-3 text-sm" id="class-features">
         <div class="p-3 rounded-lg" style="background: rgba(157, 78, 221, 0.1);">
          <h4 class="font-bold text-sm mb-1">‚úì Nivel 1: Lanzamiento de Conjuros</h4>
          <p class="text-xs opacity-80">Carisma es tu atributo de lanzamiento. Obtienes trucos y espacios de conjuro. Puedes preparar conjuros de hechicero seg√∫n el nivel de Conjuros Preparados indicado en la tabla.</p>
         </div>
         <div class="p-3 rounded-lg" style="background: rgba(157, 78, 221, 0.1);">
          <h4 class="font-bold text-sm mb-1">‚úì Nivel 1: Hechicer√≠a Innata</h4>
          <p class="text-xs opacity-80">Como acci√≥n adicional, desatas tu magia latente durante 1 minuto, obteniendo los beneficios de tu origen m√°gico. Usar este rasgo recupera usos en un descanso largo.</p>
         </div>
         <div class="p-3 rounded-lg" style="background: rgba(157, 78, 221, 0.1);">
          <h4 class="font-bold text-sm mb-1">‚úì Nivel 2: Fuente de Magia</h4>
          <p class="text-xs opacity-80">Obtienes Puntos de Hechicer√≠a iguales a tu nivel. Puedes gastar puntos para convertir espacios de conjuro, crear nuevos espacios (m√°ximo nivel 5) o potenciar tu magia.</p>
         </div>
         <div class="p-3 rounded-lg" style="background: rgba(157, 78, 221, 0.1);">
          <h4 class="font-bold text-sm mb-1">‚úì Nivel 2: Metamagia</h4>
          <p class="text-xs opacity-80">Eliges 2 opciones de metamagia. Usas puntos de hechicer√≠a para modificar tus conjuros. Obt√©n 2 m√°s en nivel 10 y 2 m√°s en nivel 17.</p>
         </div>
         <div class="p-3 rounded-lg opacity-50" id="feature-subclass">
          <h4 class="font-bold text-sm mb-1">Nivel 3: Subclase de Hechicero</h4>
          <p class="text-xs opacity-80">Elige tu Origen M√°gico que define tu especializaci√≥n y otorga rasgos especiales en varios niveles.</p>
         </div>
         <div class="p-3 rounded-lg opacity-50" id="feature-asi">
          <h4 class="font-bold text-sm mb-1">Nivel 4: Mejora de Caracter√≠stica</h4>
          <p class="text-xs opacity-80">+2 a un atributo o +1 a dos, u obt√©n un dote. Vuelves a obtener esto en niveles 8, 12 y 16.</p>
         </div>
         <div class="p-3 rounded-lg opacity-50" id="feature-recovery">
          <h4 class="font-bold text-sm mb-1">Nivel 5: Recuperaci√≥n M√°gica</h4>
          <p class="text-xs opacity-80">Tras un descanso corto, recuperas puntos de hechicer√≠a hasta la mitad de tu nivel (redondeando hacia abajo). Usable una vez entre descansos largos.</p>
         </div>
         <div class="p-3 rounded-lg opacity-50" id="feature-embodiment">
          <h4 class="font-bold text-sm mb-1">Nivel 7: Encarnaci√≥n M√°gica</h4>
          <p class="text-xs opacity-80">Puedes usar Hechicer√≠a Innata gastando 2 puntos si no tienes usos restantes. Mientras est√© activa, puedes usar hasta 2 opciones de metamagia por conjuro.</p>
         </div>
         <div class="p-3 rounded-lg opacity-50" id="feature-epic">
          <h4 class="font-bold text-sm mb-1">Nivel 19: Don √âpico</h4>
          <p class="text-xs opacity-80">Obtienes un Don √âpico u otro dote para el que cumplas condiciones.</p>
         </div>
         <div class="p-3 rounded-lg opacity-50" id="feature-apotheosis">
          <h4 class="font-bold text-sm mb-1">Nivel 20: Apoteosis Arcana</h4>
          <p class="text-xs opacity-80">Mientras Hechicer√≠a Innata est√© activa, puedes usar una opci√≥n de metamagia cada turno sin gastar puntos de hechicer√≠a.</p>
         </div>
        </div>
       </div><!-- Level Scaling Reference -->
       <div class="lg:col-span-2 card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>üìà</span> Escalado por Nivel (D&amp;D 5.5)</h2>
        <div class="overflow-x-auto">
         <table class="w-full text-xs">
          <thead>
           <tr class="border-b border-purple-500/30">
            <th class="py-2 px-2 text-left">Nv</th>
            <th class="py-2 px-1 text-center">Prof</th>
            <th class="py-2 px-1 text-center">Pts</th>
            <th class="py-2 px-1 text-center">Trucos</th>
            <th class="py-2 px-1 text-center">Conoc.</th>
            <th class="py-2 px-1 text-center">1¬∫</th>
            <th class="py-2 px-1 text-center">2¬∫</th>
            <th class="py-2 px-1 text-center">3¬∫</th>
            <th class="py-2 px-1 text-center">4¬∫</th>
            <th class="py-2 px-1 text-center">5¬∫</th>
            <th class="py-2 px-1 text-center">6¬∫</th>
            <th class="py-2 px-1 text-center">7¬∫</th>
            <th class="py-2 px-1 text-center">8¬∫</th>
            <th class="py-2 px-1 text-center">9¬∫</th>
           </tr>
          </thead>
          <tbody id="level-table">
           <!-- Populated by JS -->
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </section><!-- Notes Tab -->
     <section id="tab-notes" class="tab-panel hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
       <!-- Concentration -->
       <div class="card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>üéØ</span> Concentraci√≥n Activa</h2>
        <div class="p-4 rounded-lg mb-4" style="background: rgba(255, 183, 77, 0.1); border: 1px solid #ffb74d;">
         <div class="flex items-center justify-between mb-2">
          <span class="text-sm opacity-70">Hechizo actual:</span> <button onclick="clearConcentration()" class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30 no-print"> Romper </button>
         </div><input type="text" id="concentration-spell" class="input-field w-full text-lg" placeholder="Ninguno">
         <div class="mt-2 text-xs opacity-70">
          <strong>Recordatorio:</strong> CD de salvaci√≥n de Constituci√≥n = 10 o la mitad del da√±o (el mayor)
         </div>
        </div><!-- Active Conditions -->
        <h3 class="font-title text-sm mb-2" style="color: var(--accent-secondary);">Condiciones Activas</h3>
        <div class="flex flex-wrap gap-2 mb-3" id="conditions-list">
         <!-- Populated by JS -->
        </div>
        <div class="flex gap-2">
         <select id="condition-select" class="input-field flex-1 text-sm"> <option value="">A√±adir condici√≥n...</option> <option value="Cegado">Cegado</option> <option value="Encantado">Encantado</option> <option value="Ensordecido">Ensordecido</option> <option value="Asustado">Asustado</option> <option value="Agarrado">Agarrado</option> <option value="Incapacitado">Incapacitado</option> <option value="Invisible">Invisible</option> <option value="Paralizado">Paralizado</option> <option value="Petrificado">Petrificado</option> <option value="Envenenado">Envenenado</option> <option value="Tumbado">Tumbado</option> <option value="Derribado">Derribado</option> <option value="Aturdido">Aturdido</option> <option value="Inconsciente">Inconsciente</option> <option value="Exhausto">Exhausto</option> </select> <button onclick="addCondition()" class="px-3 py-2 magic-gradient rounded text-white text-sm no-print">+</button>
        </div>
       </div><!-- Campaign Notes -->
       <div class="card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>üìù</span> Notas de Campa√±a</h2><textarea id="campaign-notes" class="input-field w-full h-64 resize-none text-sm" placeholder="Escribe aqu√≠ tus notas de campa√±a, objetivos, NPCs importantes, etc..." onchange="saveNotes()"></textarea>
       </div><!-- Quick Rules Reference -->
       <div class="lg:col-span-2 card p-4">
        <h2 class="font-title text-lg mb-3 flex items-center gap-2" style="color: var(--accent-secondary);"><span>üìö</span> Recordatorios de Reglas</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
         <div class="p-3 rounded-lg" style="background: rgba(157, 78, 221, 0.1);">
          <h4 class="font-bold mb-2">üéØ Concentraci√≥n</h4>
          <ul class="space-y-1 opacity-80 text-xs">
           <li>‚Ä¢ Solo un hechizo de concentraci√≥n activo</li>
           <li>‚Ä¢ Salvaci√≥n CON al recibir da√±o</li>
           <li>‚Ä¢ CD = 10 o mitad del da√±o (mayor)</li>
           <li>‚Ä¢ Se pierde si est√°s incapacitado</li>
          </ul>
         </div>
         <div class="p-3 rounded-lg" style="background: rgba(157, 78, 221, 0.1);">
          <h4 class="font-bold mb-2">‚ú® Componentes (5.5)</h4>
          <ul class="space-y-1 opacity-80 text-xs">
           <li>‚Ä¢ <strong>V</strong>: Vocal (hablar)</li>
           <li>‚Ä¢ <strong>S</strong>: Som√°tico (gestos)</li>
           <li>‚Ä¢ <strong>M</strong>: Material (foco/bolsa)</li>
           <li>‚Ä¢ Hechizo Sutil los elimina</li>
          </ul>
         </div>
         <div class="p-3 rounded-lg" style="background: rgba(157, 78, 221, 0.1);">
          <h4 class="font-bold mb-2">‚ö° Acci√≥n Adicional</h4>
          <ul class="space-y-1 opacity-80 text-xs">
           <li>‚Ä¢ Hechizo bonus + cantrip solo</li>
           <li>‚Ä¢ Acelerado a√±ade acci√≥n real</li>
           <li>‚Ä¢ Conversi√≥n de puntos flexible</li>
          </ul>
         </div>
        </div>
       </div>
      </div>
     </section>
    </main>
   </div>
  </div><!-- Spell Modal -->
  <div id="spell-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4">
   <div class="card p-6 max-w-lg w-full max-h-[90%] overflow-auto">
    <div class="flex items-center justify-between mb-4">
     <h3 class="font-title text-xl" style="color: var(--accent-secondary);">A√±adir Hechizo</h3><button onclick="closeSpellModal()" class="text-2xl opacity-70 hover:opacity-100">√ó</button>
    </div>
    <div class="space-y-4">
     <div>
      <label class="text-xs opacity-70 block mb-1">Nivel del Hechizo</label> <select id="spell-level-input" class="input-field w-full" onchange="updateSpellList()"> <option value="0">Truco</option> <option value="1">1¬∫ Nivel</option> <option value="2">2¬∫ Nivel</option> <option value="3">3¬∫ Nivel</option> <option value="4">4¬∫ Nivel</option> <option value="5">5¬∫ Nivel</option> <option value="6">6¬∫ Nivel</option> <option value="7">7¬∫ Nivel</option> <option value="8">8¬∫ Nivel</option> <option value="9">9¬∫ Nivel</option> </select>
     </div>
     <div>
      <label class="text-xs opacity-70 block mb-1">Nombre del Hechizo</label> <select id="spell-name-select" class="input-field w-full" onchange="autoFillSpell()"> <option value="">Seleccionar hechizo...</option> </select>
     </div>
     <div>
      <label class="text-xs opacity-70 block mb-1">Escuela M√°gica</label>
      <div id="spell-school-display" class="input-field w-full py-2 px-3">
       -
      </div>
     </div>
     <div class="grid grid-cols-2 gap-3">
      <div>
       <label class="text-xs opacity-70 block mb-1">Nivel</label> <select id="spell-level-input" class="input-field w-full"> <option value="0">Truco</option> <option value="1">1¬∫ Nivel</option> <option value="2">2¬∫ Nivel</option> <option value="3">3¬∫ Nivel</option> <option value="4">4¬∫ Nivel</option> <option value="5">5¬∫ Nivel</option> <option value="6">6¬∫ Nivel</option> <option value="7">7¬∫ Nivel</option> <option value="8">8¬∫ Nivel</option> <option value="9">9¬∫ Nivel</option> </select>
      </div>
      <div>
       <label class="text-xs opacity-70 block mb-1">Tiempo de Lanzamiento</label> <select id="spell-casting-time" class="input-field w-full"> <option value="action">1 Acci√≥n</option> <option value="bonus">Acci√≥n Adicional</option> <option value="reaction">Reacci√≥n</option> <option value="minute">1 Minuto</option> <option value="other">Otro</option> </select>
      </div>
     </div>
     <div class="grid grid-cols-2 gap-3">
      <div>
       <label class="text-xs opacity-70 block mb-1">Alcance</label> <input type="text" id="spell-range" class="input-field w-full" placeholder="Ej: 120 pies">
      </div>
      <div>
       <label class="text-xs opacity-70 block mb-1">Duraci√≥n</label> <input type="text" id="spell-duration" class="input-field w-full" placeholder="Ej: 1 hora">
      </div>
     </div>
     <div>
      <label class="text-xs opacity-70 block mb-1">Componentes</label>
      <div class="flex gap-3">
       <label class="flex items-center gap-1 text-sm"> <input type="checkbox" id="spell-comp-v"> V </label> <label class="flex items-center gap-1 text-sm"> <input type="checkbox" id="spell-comp-s"> S </label> <label class="flex items-center gap-1 text-sm"> <input type="checkbox" id="spell-comp-m"> M </label> <label class="flex items-center gap-1 text-sm"> <input type="checkbox" id="spell-conc"> Concentraci√≥n </label>
      </div>
     </div>
     <div>
      <label class="text-xs opacity-70 block mb-1">Efecto (resumen)</label> <textarea id="spell-effect" class="input-field w-full h-20 resize-none" placeholder="Describe brevemente el efecto del hechizo..."></textarea>
     </div>
     <div class="flex items-center gap-2">
      <input type="checkbox" id="spell-combat-favorite"> <label class="text-sm">A√±adir a favoritos de combate</label>
     </div>
     <div class="flex gap-2"><button onclick="saveSpell()" class="flex-1 py-3 magic-gradient rounded-lg text-white font-bold"> Guardar Hechizo </button> <button id="delete-spell-btn" onclick="deleteSpellFromModal()" class="px-4 py-3 rounded-lg text-white font-bold no-print" style="background: rgba(244, 67, 54, 0.6); border: 1px solid #ef5350; display: none;"> Eliminar </button>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Official D&D 5.5 Sorcerer Spells
    const spellDatabase = {
      0: [
        { name: 'Agarre electrizante', school: 'Evocaci√≥n' },
        { name: 'Amistad', school: 'Encantamiento' },
        { name: 'Descarga de fuego', school: 'Evocaci√≥n' },
        { name: 'Elementalismo', school: 'Transmutaci√≥n' },
        { name: 'Estallido m√°gico', school: 'Evocaci√≥n' },
        { name: 'Fragmento mental', school: 'Encantamiento' },
        { name: 'Guardia de cuchillas', school: 'Abjuraci√≥n' },
        { name: 'Ilusi√≥n menor', school: 'Ilusionismo' },
        { name: 'Impacto certero', school: 'Adivinaci√≥n' },
        { name: 'Luces danzantes', school: 'Ilusionismo' },
        { name: 'Luz', school: 'Evocaci√≥n' },
        { name: 'Mano de mago', school: 'Conjuraci√≥n' },
        { name: 'Mensaje', school: 'Transmutaci√≥n' },
        { name: 'Prestidigitaci√≥n', school: 'Transmutaci√≥n' },
        { name: 'Rayo de escarcha', school: 'Evocaci√≥n' },
        { name: 'Reparar', school: 'Transmutaci√≥n' },
        { name: 'Rociada venenosa', school: 'Nigromancia' },
        { name: 'Salpicadura √°cida', school: 'Evocaci√≥n' },
        { name: 'Toque helado', school: 'Nigromancia' },
        { name: 'Tronar', school: 'Evocaci√≥n' }
      ],
      1: [
        { name: 'Armadura de mago', school: 'Abjuraci√≥n' },
        { name: 'Ca√≠da de pluma', school: 'Transmutaci√≥n' },
        { name: 'Cuchillo de hielo', school: 'Conjuraci√≥n' },
        { name: 'Detectar magia', school: 'Adivinaci√≥n' },
        { name: 'Disfrazarse', school: 'Ilusionismo' },
        { name: 'Dormir', school: 'Encantamiento' },
        { name: 'Entender idiomas', school: 'Adivinaci√≥n' },
        { name: 'Escudo', school: 'Abjuraci√≥n' },
        { name: 'Falsa vida', school: 'Nigromancia' },
        { name: 'Grasa', school: 'Conjuraci√≥n' },
        { name: 'Hechizar persona', school: 'Encantamiento' },
        { name: 'Imagen silenciosa', school: 'Ilusionismo' },
        { name: 'Manos ardientes', school: 'Evocaci√≥n' },
        { name: 'Nube de oscurecimiento', school: 'Conjuraci√≥n' },
        { name: 'Ola atronadora', school: 'Evocaci√≥n' },
        { name: 'Orbe crom√°tico', school: 'Evocaci√≥n' },
        { name: 'Proyectil m√°gico', school: 'Evocaci√≥n' },
        { name: 'Rayo de hechicer√≠a', school: 'Evocaci√≥n' },
        { name: 'Rayo nauseabundo', school: 'Nigromancia' },
        { name: 'Retirada expeditiva', school: 'Transmutaci√≥n' },
        { name: 'Rociada de color', school: 'Ilusionismo' },
        { name: 'Salto', school: 'Transmutaci√≥n' }
      ],
      2: [
        { name: 'Abrir', school: 'Transmutaci√≥n' },
        { name: 'Agrandar/reducir', school: 'Transmutaci√≥n' },
        { name: 'Aliento de drag√≥n', school: 'Transmutaci√≥n' },
        { name: 'Alterar el propio aspecto', school: 'Transmutaci√≥n' },
        { name: 'Arma m√°gica', school: 'Transmutaci√≥n' },
        { name: 'Clavo mental', school: 'Adivinaci√≥n' },
        { name: 'Contorno borroso', school: 'Ilusionismo' },
        { name: 'Corona de la locura', school: 'Encantamiento' },
        { name: 'Detectar pensamientos', school: 'Adivinaci√≥n' },
        { name: 'Esfera de llamas', school: 'Evocaci√≥n' },
        { name: 'Fuerza fantasmal', school: 'Ilusionismo' },
        { name: 'Hacer a√±icos', school: 'Evocaci√≥n' },
        { name: 'Hoja de fuego', school: 'Evocaci√≥n' },
        { name: 'Imagen m√∫ltiple', school: 'Ilusionismo' },
        { name: 'Inmovilizar persona', school: 'Encantamiento' },
        { name: 'Invisibilidad', school: 'Ilusionismo' },
        { name: 'Levitar', school: 'Transmutaci√≥n' },
        { name: 'Nube de dagas', school: 'Conjuraci√≥n' },
        { name: 'Oscuridad', school: 'Evocaci√≥n' },
        { name: 'Paso brumoso', school: 'Conjuraci√≥n' },
        { name: 'Potenciar caracter√≠stica', school: 'Transmutaci√≥n' },
        { name: 'R√°faga de viento', school: 'Evocaci√≥n' },
        { name: 'Rayo abrasador', school: 'Evocaci√≥n' },
        { name: 'Sordera/ceguera', school: 'Transmutaci√≥n' },
        { name: 'Sugesti√≥n', school: 'Encantamiento' },
        { name: 'Telara√±a', school: 'Conjuraci√≥n' },
        { name: 'Trepar cual ar√°cnido', school: 'Transmutaci√≥n' },
        { name: 'Ver invisibilidad', school: 'Adivinaci√≥n' },
        { name: 'Vigor arcano', school: 'Abjuraci√≥n' },
        { name: 'Visi√≥n en la oscuridad', school: 'Transmutaci√≥n' }
      ],
      3: [
        { name: 'Acelerar', school: 'Transmutaci√≥n' },
        { name: 'Bola de fuego', school: 'Evocaci√≥n' },
        { name: 'Caminar sobre el agua', school: 'Transmutaci√≥n' },
        { name: 'Clarividencia', school: 'Adivinaci√≥n' },
        { name: 'Contrahechizo', school: 'Abjuraci√≥n' },
        { name: 'Desplazamiento', school: 'Transmutaci√≥n' },
        { name: 'Disipar magia', school: 'Abjuraci√≥n' },
        { name: 'Don de lenguas', school: 'Adivinaci√≥n' },
        { name: 'Forma gaseosa', school: 'Transmutaci√≥n' },
        { name: 'Imagen mayor', school: 'Ilusionismo' },
        { name: 'Luz del d√≠a', school: 'Evocaci√≥n' },
        { name: 'Nube apestosa', school: 'Conjuraci√≥n' },
        { name: 'Patr√≥n hipn√≥tico', school: 'Ilusionismo' },
        { name: 'Protecci√≥n contra energ√≠a', school: 'Abjuraci√≥n' },
        { name: 'Ralentizar', school: 'Transmutaci√≥n' },
        { name: 'Rel√°mpago', school: 'Evocaci√≥n' },
        { name: 'Respirar bajo el agua', school: 'Transmutaci√≥n' },
        { name: 'Terror', school: 'Ilusionismo' },
        { name: 'Toque vamp√≠rico', school: 'Nigromancia' },
        { name: 'Tormenta de aguanieve', school: 'Conjuraci√≥n' },
        { name: 'Volar', school: 'Transmutaci√≥n' }
      ],
      4: [
        { name: 'Confusi√≥n', school: 'Encantamiento' },
        { name: 'Destierro', school: 'Abjuraci√≥n' },
        { name: 'Dominar bestia', school: 'Encantamiento' },
        { name: 'Escudo de fuego', school: 'Evocaci√≥n' },
        { name: 'Esfera vitri√≥lica', school: 'Evocaci√≥n' },
        { name: 'Hechizar monstruo', school: 'Encantamiento' },
        { name: 'Invisibilidad mejorada', school: 'Ilusionismo' },
        { name: 'Marchitar', school: 'Nigromancia' },
        { name: 'Muro de fuego', school: 'Evocaci√≥n' },
        { name: 'Piel p√©trea', school: 'Transmutaci√≥n' },
        { name: 'Polimorfar', school: 'Transmutaci√≥n' },
        { name: 'Puerta dimensional', school: 'Conjuraci√≥n' },
        { name: 'Tormenta de hielo', school: 'Evocaci√≥n' }
      ],
      5: [
        { name: 'Animar objetos', school: 'Transmutaci√≥n' },
        { name: 'Apariencia', school: 'Ilusionismo' },
        { name: 'C√≠rculo de teletransportaci√≥n', school: 'Conjuraci√≥n' },
        { name: 'Cono de fr√≠o', school: 'Evocaci√≥n' },
        { name: 'Creaci√≥n', school: 'Ilusionismo' },
        { name: 'Dominar persona', school: 'Encantamiento' },
        { name: 'Est√°tica sin√°ptica', school: 'Encantamiento' },
        { name: 'Inmovilizar monstruo', school: 'Encantamiento' },
        { name: 'Mano de Bigby', school: 'Evocaci√≥n' },
        { name: 'Muro de piedra', school: 'Evocaci√≥n' },
        { name: 'Nube aniquiladora', school: 'Conjuraci√≥n' },
        { name: 'Plaga de insectos', school: 'Conjuraci√≥n' },
        { name: 'Telequinesis', school: 'Transmutaci√≥n' }
      ],
      6: [
        { name: 'C√≠rculo de muerte', school: 'Nigromancia' },
        { name: 'De la carne a la piedra', school: 'Transmutaci√≥n' },
        { name: 'Desintegrar', school: 'Transmutaci√≥n' },
        { name: 'Esfera congelante de Otiluke', school: 'Evocaci√≥n' },
        { name: 'Globo de invulnerabilidad', school: 'Abjuraci√≥n' },
        { name: 'Mal de ojo', school: 'Nigromancia' },
        { name: 'Mover la tierra', school: 'Transmutaci√≥n' },
        { name: 'Puerta arcana', school: 'Conjuraci√≥n' },
        { name: 'Rayo solar', school: 'Evocaci√≥n' },
        { name: 'Rel√°mpago en cadena', school: 'Evocaci√≥n' },
        { name: 'Sugesti√≥n en masa', school: 'Encantamiento' },
        { name: 'Visi√≥n veraz', school: 'Adivinaci√≥n' }
      ],
      7: [
        { name: 'Bola de fuego de explosi√≥n retardada', school: 'Evocaci√≥n' },
        { name: 'Dedo de la muerte', school: 'Nigromancia' },
        { name: 'Desplazamiento entre planos', school: 'Conjuraci√≥n' },
        { name: 'Excursi√≥n et√©rea', school: 'Conjuraci√≥n' },
        { name: 'Invertir la gravedad', school: 'Transmutaci√≥n' },
        { name: 'Rociada prism√°tica', school: 'Evocaci√≥n' },
        { name: 'Teletransporte', school: 'Conjuraci√≥n' },
        { name: 'Tormenta de fuego', school: 'Evocaci√≥n' }
      ],
      8: [
        { name: 'Dominar monstruo', school: 'Encantamiento' },
        { name: 'Explosi√≥n solar', school: 'Evocaci√≥n' },
        { name: 'Nube incendiaria', school: 'Conjuraci√≥n' },
        { name: 'Palabra de poder: aturdir', school: 'Encantamiento' },
        { name: 'Semiplano', school: 'Conjuraci√≥n' },
        { name: 'Terremoto', school: 'Transmutaci√≥n' }
      ],
      9: [
        { name: 'Deseo', school: 'Conjuraci√≥n' },
        { name: 'Palabra de poder: matar', school: 'Encantamiento' },
        { name: 'Parar el tiempo', school: 'Transmutaci√≥n' },
        { name: 'Portal', school: 'Conjuraci√≥n' },
        { name: 'Tormenta de meteoritos', school: 'Evocaci√≥n' }
      ]
    };

    // State management
    let characterData = {
      name: '', class: 'Hechicero', level: 1, race: '', background: '', alignment: '',
      subclass: '', ac: 10, speed: '30 pies', hpMax: 6, hpCurrent: 6, hpTemp: 0,
      attributes: { str: 8, dex: 14, con: 14, int: 10, wis: 12, cha: 16 },
      saves: { str: false, dex: false, con: true, int: false, wis: false, cha: true },
      skills: {},
      sorceryPointsUsed: 0,
      spellSlotsUsed: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 },
      metamagicKnown: [],
      conditions: [],
      concentrationSpell: '',
      notes: '',
      deathSaves: { success: 0, failure: 0 },
      hasInspiration: false
    };

    let spells = [];

    // Sorcerer level progression data (D&D 5.5 - 2024)
    const levelData = [
      { level: 1, prof: 2, points: 0, cantrips: 4, known: 2, slots: [2,0,0,0,0,0,0,0,0] },
      { level: 2, prof: 2, points: 2, cantrips: 4, known: 4, slots: [3,0,0,0,0,0,0,0,0] },
      { level: 3, prof: 2, points: 3, cantrips: 4, known: 6, slots: [4,2,0,0,0,0,0,0,0] },
      { level: 4, prof: 2, points: 4, cantrips: 5, known: 7, slots: [4,3,0,0,0,0,0,0,0] },
      { level: 5, prof: 3, points: 5, cantrips: 5, known: 9, slots: [4,3,2,0,0,0,0,0,0] },
      { level: 6, prof: 3, points: 6, cantrips: 5, known: 10, slots: [4,3,3,0,0,0,0,0,0] },
      { level: 7, prof: 3, points: 7, cantrips: 5, known: 11, slots: [4,3,3,1,0,0,0,0,0] },
      { level: 8, prof: 3, points: 8, cantrips: 5, known: 12, slots: [4,3,3,2,0,0,0,0,0] },
      { level: 9, prof: 4, points: 9, cantrips: 5, known: 14, slots: [4,3,3,3,1,0,0,0,0] },
      { level: 10, prof: 4, points: 10, cantrips: 6, known: 15, slots: [4,3,3,3,2,0,0,0,0] },
      { level: 11, prof: 4, points: 11, cantrips: 6, known: 16, slots: [4,3,3,3,2,1,0,0,0] },
      { level: 12, prof: 4, points: 12, cantrips: 6, known: 16, slots: [4,3,3,3,2,1,0,0,0] },
      { level: 13, prof: 5, points: 13, cantrips: 6, known: 17, slots: [4,3,3,3,2,1,1,0,0] },
      { level: 14, prof: 5, points: 14, cantrips: 6, known: 17, slots: [4,3,3,3,2,1,1,0,0] },
      { level: 15, prof: 5, points: 15, cantrips: 6, known: 18, slots: [4,3,3,3,2,1,1,1,0] },
      { level: 16, prof: 5, points: 16, cantrips: 6, known: 18, slots: [4,3,3,3,2,1,1,1,0] },
      { level: 17, prof: 6, points: 17, cantrips: 6, known: 19, slots: [4,3,3,3,2,1,1,1,1] },
      { level: 18, prof: 6, points: 18, cantrips: 6, known: 20, slots: [4,3,3,3,3,1,1,1,1] },
      { level: 19, prof: 6, points: 19, cantrips: 6, known: 21, slots: [4,3,3,3,3,2,1,1,1] },
      { level: 20, prof: 6, points: 20, cantrips: 6, known: 22, slots: [4,3,3,3,3,2,2,1,1] }
    ];

    const skills = [
      { name: 'Acrobacias', attr: 'dex' },
      { name: 'Trato con Animales', attr: 'wis' },
      { name: 'Arcano', attr: 'int' },
      { name: 'Atletismo', attr: 'str' },
      { name: 'Enga√±o', attr: 'cha' },
      { name: 'Historia', attr: 'int' },
      { name: 'Perspicacia', attr: 'wis' },
      { name: 'Intimidaci√≥n', attr: 'cha' },
      { name: 'Investigaci√≥n', attr: 'int' },
      { name: 'Medicina', attr: 'wis' },
      { name: 'Naturaleza', attr: 'int' },
      { name: 'Percepci√≥n', attr: 'wis' },
      { name: 'Interpretaci√≥n', attr: 'cha' },
      { name: 'Persuasi√≥n', attr: 'cha' },
      { name: 'Religi√≥n', attr: 'int' },
      { name: 'Juego de Manos', attr: 'dex' },
      { name: 'Sigilo', attr: 'dex' },
      { name: 'Supervivencia', attr: 'wis' }
    ];

    const subclassFeatures = {
      aberrant: 'Mente Aberrante: Tu magia procede de fuerzas c√≥smicas. Obtienes telepat√≠a, visi√≥n verdadera en oscuridad m√°gica, y rasgos que te permiten detectar magia psi√≥nica.',
      draconic: 'Hechicer√≠a Drac√≥nica: Tu magia est√° atada a un drag√≥n ancestral. Elige un tipo de drag√≥n para obtener resistencia a da√±o, escamas drac√≥nicas, y mejoras en hechizos de tu tipo.',
      wild: 'Magia Salvaje: Tu magia es impredecible y ca√≥tica. Ganas la capacidad de causar efectos salvajes cuando lanzas hechizos, con oportunidades de ventaja en tiradas.',
      divine: 'Hechicer√≠a Divina: Tu poder m√°gico es otorgado por una deidad. Ganas acceso a hechizos de cl√©rigo, canalizas energ√≠a sagrada, y obtienes mejoras de lanzamiento.'
    };

    const metamagicDescriptions = {
      quickened: {
        title: 'Conjuro Acelerado',
        cost: 'Coste: 2 puntos de hechicer√≠a',
        text: 'Cuando lanzas un conjuro con un tiempo de lanzamiento de una acci√≥n, puedes gastar 2 puntos de hechicer√≠a para que el tiempo de lanzamiento sea de una acci√≥n adicional para ese lanzamiento. No puedes modificar un conjuro de esta forma si ya has lanzado un conjuro de nivel 1 o superior en este turno ni lanzar un conjuro de nivel 1 o superior despu√©s de hacerlo.'
      },
      seeking: {
        title: 'Conjuro Buscador',
        cost: 'Coste: 1 punto de hechicer√≠a',
        text: 'Si realizas una tirada de ataque para un conjuro y fallas, puedes gastar 1 punto de hechicer√≠a para volver a tirar el d20, pero debes usar el nuevo resultado. Puedes usar Conjuro buscador aunque ya hayas empleado otra opci√≥n de metamagia durante el lanzamiento del conjuro.'
      },
      careful: {
        title: 'Conjuro Cuidadoso',
        cost: 'Coste: 1 punto de hechicer√≠a',
        text: 'Cuando lanzas un conjuro que obliga a otras criaturas a realizar una tirada de salvaci√≥n, puedes gastar 1 punto de hechicer√≠a y escoger hasta una cantidad de criaturas igual a tu modificador por Carisma (m√≠nimo una). Las criaturas elegidas tienen √©xito autom√°ticamente en sus tiradas de salvaci√≥n contra el conjuro y no reciben da√±o alguno si normalmente recibir√≠an la mitad al superarla.'
      },
      distant: {
        title: 'Conjuro Distante',
        cost: 'Coste: 1 punto de hechicer√≠a',
        text: 'Cuando lanzas un conjuro que tenga como m√≠nimo un alcance de 1,5 m, puedes gastar 1 punto de hechicer√≠a para duplicar su alcance. Como alternativa, cuando lanzas un conjuro que tenga un alcance de toque, puedes gastar 1 punto para que su alcance sea de 9 m.'
      },
      extended: {
        title: 'Conjuro Extendido',
        cost: 'Coste: 1 punto de hechicer√≠a',
        text: 'Cuando lanzas un conjuro que tenga una duraci√≥n de al menos 1 minuto, puedes gastar 1 punto de hechicer√≠a para duplicar su duraci√≥n, hasta un m√°ximo de 24 horas. Si el conjuro requiere concentraci√≥n, tienes ventaja en las tiradas de salvaci√≥n para mantenerla.'
      },
      twin: {
        title: 'Conjuro Gemelo',
        cost: 'Coste: 1 punto de hechicer√≠a',
        text: 'Cuando lanzas un conjuro, como hechizar persona, que puede lanzarse con espacios de niveles superiores para hacer objetivo a criaturas adicionales, puedes gastar 1 punto de hechicer√≠a para aumentar el nivel efectivo del conjuro en 1.'
      },
      heightened: {
        title: 'Conjuro Intensificado',
        cost: 'Coste: 2 puntos de hechicer√≠a',
        text: 'Cuando lanzas un conjuro que obliga como m√≠nimo a una criatura a hacer una tirada de salvaci√≥n, puedes gastar 2 puntos de hechicer√≠a para que uno de los objetivos tenga desventaja en las tiradas de salvaci√≥n que haga contra ese conjuro.'
      },
      empowered: {
        title: 'Conjuro Potenciado',
        cost: 'Coste: 1 punto de hechicer√≠a',
        text: 'Cuando tiras el da√±o de un conjuro, puedes gastar 1 punto de hechicer√≠a para repetir la tirada de, como m√°ximo, tantos dados de da√±o como tu modificador por Carisma (m√≠nimo un dado) y debes usar los nuevos resultados. Puedes usar Conjuro potenciado aunque ya hayas empleado otra opci√≥n de metamagia durante el lanzamiento del conjuro.'
      },
      subtle: {
        title: 'Conjuro Sutil',
        cost: 'Coste: 1 punto de hechicer√≠a',
        text: 'Cuando lanzas un conjuro, puedes gastar 1 punto de hechicer√≠a para hacerlo sin componentes verbales, som√°ticos ni materiales, salvo los materiales que se consuman como parte del conjuro o que tengan un coste especificado.'
      },
      transmuted: {
        title: 'Conjuro Transmutado',
        cost: 'Coste: 1 punto de hechicer√≠a',
        text: 'Cuando lanzas un conjuro que inflija un tipo de da√±o de la siguiente lista, puedes gastar 1 punto de hechicer√≠a para cambiarlo por otro de la lista: √°cido, fr√≠o, fuego, rel√°mpago, trueno o veneno.'
      }
    };

    // Inicializar app con localStorage
    function initApp() {
      initializeUI();
      loadFromLocalStorage();
    }

    async function loadFromLocalStorage() {
      try {
        let loadedChar = null;
        let loadedSpells = null;

        // 1. Try URL hash first (most reliable on iOS Safari file://)
        const hashData = loadFromHash();
        if (hashData) {
          loadedChar = hashData.c ? JSON.stringify(hashData.c) : null;
          loadedSpells = hashData.s ? JSON.stringify(hashData.s) : null;
        }

        // 2. Fallback to IndexedDB
        if (!loadedChar) loadedChar = await idbGet('character');
        if (!loadedSpells) loadedSpells = await idbGet('spells');

        // 3. Fallback to localStorage
        if (!loadedChar) loadedChar = localStorage.getItem('dnd55_sorcerer_character');
        if (!loadedSpells) loadedSpells = localStorage.getItem('dnd55_sorcerer_spells');

        if (loadedChar) {
          const loaded = JSON.parse(loadedChar);
          characterData = { ...characterData, ...loaded };
          applyCharacterData();
        } else {
          applyCharacterData();
        }

        spells = loadedSpells ? JSON.parse(loadedSpells) : [];

        renderSpells();
        renderCombatSpells();
        updateSpellCounts();
      } catch (e) {
        console.error('Error cargando datos', e);
        applyCharacterData();
        spells = [];
        renderSpells();
        renderCombatSpells();
        updateSpellCounts();
      }
    }

    function applyCharacterData() {
      document.getElementById('char-name').value = characterData.name || '';
      document.getElementById('char-class').value = characterData.class || 'Hechicero';
      document.getElementById('char-level').value = characterData.level || 1;
      document.getElementById('char-race').value = characterData.race || '';
      document.getElementById('char-background').value = characterData.background || '';
      document.getElementById('char-alignment').value = characterData.alignment || '';
      document.getElementById('char-subclass').value = characterData.subclass || '';
      document.getElementById('stat-ac').value = characterData.ac || 10;
      document.getElementById('stat-speed').value = characterData.speed || '30 pies';
      document.getElementById('hp-max').value = characterData.hpMax || 6;
      document.getElementById('hp-current').value = characterData.hpCurrent || 6;
      document.getElementById('hp-temp').value = characterData.hpTemp || 0;
      document.getElementById('concentration-spell').value = characterData.concentrationSpell || '';
      document.getElementById('campaign-notes').value = characterData.notes || '';

      if (!characterData.deathSaves) {
        characterData.deathSaves = { success: 0, failure: 0 };
      }

      hasInspiration = !!characterData.hasInspiration;
      updateInspirationDisplay();

      // Apply attributes
      const attrBoxes = document.querySelectorAll('[data-attr]');
      attrBoxes.forEach(box => {
        const attr = box.dataset.attr;
        const input = box.querySelector('.attr-score');
        if (characterData.attributes && characterData.attributes[attr]) {
          input.value = characterData.attributes[attr];
        }
      });

      // Apply saves
      document.querySelectorAll('#saving-throws .checkbox-skill').forEach(cb => {
        const save = cb.dataset.save;
        if (characterData.saves && characterData.saves[save]) {
          cb.classList.add('checked');
        }
      });

      // Apply skills
      if (characterData.skills) {
        Object.entries(characterData.skills).forEach(([skill, level]) => {
          const checkbox = document.querySelector(`[data-skill="${skill}"]`);
          if (checkbox) {
            checkbox.classList.remove('checked', 'expertise');
            if (level === 1) checkbox.classList.add('checked');
            if (level === 2) checkbox.classList.add('expertise');
          }
        });
      }

      // Apply metamagic
      if (characterData.metamagicKnown) {
        document.querySelectorAll('.metamagic-tag').forEach(tag => {
          if (characterData.metamagicKnown.includes(tag.dataset.meta)) {
            tag.classList.add('active');
          }
        });
        renderMetamagicDescriptions();
      }

      // Apply conditions
      renderConditions();
      
      updateHealthBar();
      calculateModifiers();
      updateLevel();
      updateSubclass();
      renderDeathSaves();
    }

    function initializeUI() {
      renderSkills();
      renderLevelTable();
      updateLevel();
      calculateModifiers();
    }

    function renderSkills() {
      const container = document.getElementById('skills-list');
      if (!container) return;
      container.innerHTML = '';

      const attrOrder = ['str', 'dex', 'int', 'wis', 'cha'];
      const attrShort = {
        str: 'FUE',
        dex: 'DES',
        int: 'INT',
        wis: 'SAB',
        cha: 'CAR'
      };
      const attrNames = {
        str: 'Fuerza',
        dex: 'Destreza',
        int: 'Inteligencia',
        wis: 'Sabidur√≠a',
        cha: 'Carisma'
      };

      const sortedSkills = [...skills].sort((a, b) => {
        if (a.attr === b.attr) return a.name.localeCompare(b.name, 'es');
        return attrOrder.indexOf(a.attr) - attrOrder.indexOf(b.attr);
      });

      attrOrder.forEach(attr => {
        const col = document.createElement('div');
        col.className = 'space-y-1';

        col.innerHTML = `
          <h3 class="font-title text-xs mb-1 opacity-80" style="color: var(--accent-primary);">
            ${attrNames[attr]} (${attrShort[attr]})
          </h3>
        `;

        const colSkills = sortedSkills.filter(s => s.attr === attr);
        colSkills.forEach(skill => {
          const row = document.createElement('div');
          row.className = 'flex items-center gap-2 p-1 rounded hover:bg-purple-500/10';
          row.innerHTML = `
            <div class="checkbox-skill" data-skill="${skill.name}" onclick="toggleSkill(this)" ondblclick="toggleExpertise(this)"></div>
            <span class="w-8 text-right skill-bonus" data-skill="${skill.name}">+0</span>
            <span class="flex-1">${skill.name} (${attrShort[skill.attr] || skill.attr.toUpperCase()})</span>
          `;
          col.appendChild(row);
        });

        container.appendChild(col);
      });
    }

    function renderLevelTable() {
      const tbody = document.getElementById('level-table');
      tbody.innerHTML = levelData.map((l, idx) => `
        <tr class="${idx === characterData.level - 1 ? 'bg-purple-500/20' : ''} border-b border-purple-500/10">
          <td class="py-1 px-2 font-bold">${l.level}</td>
          <td class="py-1 px-1 text-center">+${l.prof}</td>
          <td class="py-1 px-1 text-center">${l.points}</td>
          <td class="py-1 px-1 text-center">${l.cantrips}</td>
          <td class="py-1 px-1 text-center">${l.known}</td>
          ${l.slots.map(s => `<td class="py-1 px-1 text-center ${s ? '' : 'opacity-30'}">${s || '-'}</td>`).join('')}
        </tr>
      `).join('');
    }

    function calculateModifiers() {
      const attrBoxes = document.querySelectorAll('[data-attr]');
      const mods = {};

      attrBoxes.forEach(box => {
        const attr = box.dataset.attr;
        const score = parseInt(box.querySelector('.attr-score').value) || 10;
        const mod = Math.floor((score - 10) / 2);
        mods[attr] = mod;
        box.querySelector('.attr-mod').textContent = (mod >= 0 ? '+' : '') + mod;
        characterData.attributes[attr] = score;
      });

      // Update initiative
      document.getElementById('stat-initiative').textContent = (mods.dex >= 0 ? '+' : '') + mods.dex;

      // Update saving throws
      const level = parseInt(document.getElementById('char-level').value) || 1;
      const profBonus = levelData[level - 1].prof;

      document.querySelectorAll('#saving-throws .checkbox-skill').forEach(cb => {
        const save = cb.dataset.save;
        const isProficient = cb.classList.contains('checked');
        const bonus = mods[save] + (isProficient ? profBonus : 0);
        const bonusEl = cb.parentElement.querySelector('.save-bonus');
        bonusEl.textContent = (bonus >= 0 ? '+' : '') + bonus;
      });

      // Update skills
      skills.forEach(skill => {
        const checkbox = document.querySelector(`[data-skill="${skill.name}"]`);
        const bonusEl = document.querySelector(`.skill-bonus[data-skill="${skill.name}"]`);
        if (checkbox && bonusEl) {
          let bonus = mods[skill.attr];
          if (checkbox.classList.contains('expertise')) {
            bonus += profBonus * 2;
          } else if (checkbox.classList.contains('checked')) {
            bonus += profBonus;
          }
          bonusEl.textContent = (bonus >= 0 ? '+' : '') + bonus;
        }
      });

      // Update spell DC and attack
      const chaMod = mods.cha;
      document.getElementById('spell-dc').textContent = 8 + profBonus + chaMod;
      document.getElementById('spell-attack').textContent = '+' + (profBonus + chaMod);

      saveCharacterDebounced();
    }

    function updateLevel() {
      const level = parseInt(document.getElementById('char-level').value) || 1;
      characterData.level = level;
      const data = levelData[level - 1];

      document.getElementById('proficiency-bonus').textContent = '+' + data.prof;
      document.getElementById('sorcery-max').textContent = data.points;
      document.getElementById('spells-known-max').textContent = data.known;
      document.getElementById('cantrips-max').textContent = data.cantrips;

      // Update sorcery points display
      renderSorceryPoints(data.points);

      // Update spell slots
      renderSpellSlots(data.slots);

      // Update class features visibility
      document.getElementById('feature-subclass').style.opacity = level >= 3 ? '1' : '0.5';
      document.getElementById('feature-asi').style.opacity = level >= 4 ? '1' : '0.5';
      document.getElementById('feature-recovery').style.opacity = level >= 5 ? '1' : '0.5';
      document.getElementById('feature-embodiment').style.opacity = level >= 7 ? '1' : '0.5';
      document.getElementById('feature-epic').style.opacity = level >= 19 ? '1' : '0.5';
      document.getElementById('feature-apotheosis').style.opacity = level >= 20 ? '1' : '0.5';

      renderLevelTable();
      calculateModifiers();
    }

    function renderSorceryPoints(max) {
      const container = document.getElementById('sorcery-points-container');
      const used = characterData.sorceryPointsUsed || 0;
      container.innerHTML = '';
      
      for (let i = 0; i < max; i++) {
        const point = document.createElement('div');
        point.className = 'sorcery-point' + (i < max - used ? ' used' : '');
        point.onclick = () => toggleSorceryPoint(i);
        container.appendChild(point);
      }

      document.getElementById('sorcery-current').textContent = max - used;
    }

    function toggleSorceryPoint(index) {
      const level = parseInt(document.getElementById('char-level').value) || 1;
      const max = levelData[level - 1].points;
      const available = max - characterData.sorceryPointsUsed;
      
      if (index < available) {
        characterData.sorceryPointsUsed++;
      } else {
        characterData.sorceryPointsUsed = max - index - 1;
      }
      
      renderSorceryPoints(max);
      saveCharacterDebounced();
    }

    function renderSpellSlots(slots) {
      const container = document.getElementById('spell-slots-container');
      container.innerHTML = '';

      slots.forEach((count, idx) => {
        if (count > 0) {
          const levelNum = idx + 1;
          const used = characterData.spellSlotsUsed[levelNum] || 0;
          
          const div = document.createElement('div');
          div.className = 'flex items-center justify-between p-2 rounded-lg';
          div.style.background = 'rgba(157, 78, 221, 0.1)';
          div.innerHTML = `
            <span class="text-sm font-bold">${levelNum}¬∫</span>
            <div class="flex gap-1">
              ${Array(count).fill(0).map((_, i) => `
                <div class="spell-slot ${i < count - used ? 'used' : ''}" onclick="toggleSpellSlot(${levelNum}, ${i})"></div>
              `).join('')}
            </div>
          `;
          container.appendChild(div);
        }
      });

      // Also update spells by level section
      renderSpellsByLevel(slots);
    }

    function toggleSpellSlot(level, index) {
      const levelNum = parseInt(document.getElementById('char-level').value) || 1;
      const maxSlots = levelData[levelNum - 1].slots[level - 1];
      const available = maxSlots - (characterData.spellSlotsUsed[level] || 0);
      
      if (index < available) {
        characterData.spellSlotsUsed[level] = (characterData.spellSlotsUsed[level] || 0) + 1;
      } else {
        characterData.spellSlotsUsed[level] = maxSlots - index - 1;
      }
      
      updateLevel();
      saveCharacterDebounced();
    }

    function renderSpellsByLevel(slots) {
      const container = document.getElementById('spells-by-level');
      container.innerHTML = '';

      slots.forEach((count, idx) => {
        if (count > 0) {
          const levelNum = idx + 1;
          const levelSpells = spells.filter(s => s.level === levelNum);
          
          const div = document.createElement('div');
          div.className = 'mb-4';
          div.innerHTML = `
            <h3 class="font-title text-sm mb-2 flex items-center gap-2 opacity-80">
              <span style="color: var(--accent-primary);">‚ú¶</span> Nivel ${levelNum}
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2" id="spells-level-${levelNum}">
              ${levelSpells.map(s => renderSpellCard(s)).join('')}
            </div>
            <button onclick="addSpell(${levelNum})" class="mt-2 w-full py-2 border border-dashed border-purple-500/30 rounded-lg text-xs opacity-60 hover:opacity-100 hover:bg-purple-500/10 transition no-print">
              + A√±adir hechizo de nivel ${levelNum}
            </button>
          `;
          container.appendChild(div);
        }
      });
    }

    function renderSpells() {
      // Render cantrips
      const cantripsList = document.getElementById('cantrips-list');
      const cantrips = spells.filter(s => s.level === 0);
      cantripsList.innerHTML = cantrips.map(s => renderSpellCard(s)).join('');

      // Update by level
      const level = parseInt(document.getElementById('char-level').value) || 1;
      renderSpellSlots(levelData[level - 1].slots);
    }

    function renderSpellCard(spell) {
      const actionColors = {
        '1 Acci√≥n': 'action',
        'Acci√≥n Adicional': 'bonus',
        'Reacci√≥n': 'reaction'
      };
      const actionClass = actionColors[spell.castingTime] || 'action';
      const getActionBadge = (time) => {
        if (time === 'Acci√≥n Adicional') return 'BA';
        if (time === 'Reacci√≥n') return 'R';
        if (time === '1 Acci√≥n') return 'A';
        return time.substring(0, 1).toUpperCase();
      };
      const components = [];
      if (spell.compV) components.push('V');
      if (spell.compS) components.push('S');
      if (spell.compM) components.push('M');

      return `
        <div class="p-3 rounded-lg relative group" style="background: rgba(157, 78, 221, 0.1); border: 1px solid rgba(157, 78, 221, 0.2);">
          <button onclick="editSpell('${spell.id}')" class="absolute top-2 right-2 w-6 h-6 rounded-full bg-blue-500/20 text-blue-400 text-xs opacity-0 group-hover:opacity-100 transition no-print" title="Editar">‚úé</button>
          <div class="flex items-start justify-between mb-1">
            <div>
              <span class="font-bold text-sm">${spell.name}</span>
              ${spell.school ? '<div class="text-xs opacity-70">' + spell.school + '</div>' : ''}
            </div>
            <span class="action-badge ${actionClass}">${getActionBadge(spell.castingTime)}</span>
          </div>
          <div class="flex flex-wrap gap-2 text-xs opacity-70 mb-2">
            <span>üìè ${spell.range}</span>
            <span>‚è±Ô∏è ${spell.duration}</span>
            ${spell.concentration ? '<span class="concentration-indicator">üéØ Conc.</span>' : ''}
          </div>
          <div class="text-xs opacity-70 mb-1">${components.join(', ')}</div>
          <p class="text-xs opacity-80">${spell.effect || ''}</p>
        </div>
      `;
    }

    function renderCombatSpells() {
      const container = document.getElementById('combat-spells');
      const combatSpells = spells.filter(s => s.combatFavorite);
      container.innerHTML = combatSpells.map(s => renderSpellCard(s)).join('') || 
        '<p class="text-sm opacity-50 col-span-3 text-center py-4">No hay hechizos de combate favoritos</p>';
    }

    function updateSpellCounts() {
      const cantrips = spells.filter(s => s.level === 0).length;
      const known = spells.filter(s => s.level > 0).length;
      document.getElementById('cantrips-count').textContent = cantrips;
      document.getElementById('spells-known-count').textContent = known;
    }

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      
      document.getElementById('tab-' + tabName).classList.remove('hidden');
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    }

    // Skill toggles
    function toggleSkill(el) {
      if (el.classList.contains('expertise')) {
        el.classList.remove('expertise');
        characterData.skills[el.dataset.skill] = 0;
      } else if (el.classList.contains('checked')) {
        el.classList.remove('checked');
        el.classList.add('expertise');
        characterData.skills[el.dataset.skill] = 2;
      } else {
        el.classList.add('checked');
        characterData.skills[el.dataset.skill] = 1;
      }
      calculateModifiers();
    }

    function toggleExpertise(el) {
      el.classList.remove('checked');
      if (el.classList.contains('expertise')) {
        el.classList.remove('expertise');
        characterData.skills[el.dataset.skill] = 0;
      } else {
        el.classList.add('expertise');
        characterData.skills[el.dataset.skill] = 2;
      }
      calculateModifiers();
    }

    function toggleSave(el) {
      el.classList.toggle('checked');
      characterData.saves[el.dataset.save] = el.classList.contains('checked');
      calculateModifiers();
    }

    function toggleMetamagic(el) {
      el.classList.toggle('active');
      const meta = el.dataset.meta;
      if (el.classList.contains('active')) {
        if (!characterData.metamagicKnown.includes(meta)) {
          characterData.metamagicKnown.push(meta);
        }
      } else {
        characterData.metamagicKnown = characterData.metamagicKnown.filter(m => m !== meta);
      }
      renderMetamagicDescriptions();
      saveCharacterDebounced();
    }

    function renderMetamagicDescriptions() {
      const container = document.getElementById('metamagic-descriptions');
      if (!container) return;

      const selected = characterData.metamagicKnown || [];
      if (!selected.length) {
        container.innerHTML = '<p class="text-xs opacity-60">No has seleccionado ninguna opci√≥n de metamagia.</p>';
        return;
      }

      const ordered = [...selected].sort();
      container.innerHTML = ordered.map(key => {
        const info = metamagicDescriptions[key];
        if (!info) return '';
        return `
          <div class="p-2 rounded-md" style="background: rgba(157, 78, 221, 0.1); border: 1px solid rgba(157, 78, 221, 0.4);">
            <div class="font-semibold text-[0.7rem] mb-1" style="color: var(--accent-secondary); text-transform: uppercase; letter-spacing: 0.06em;">
              ${info.title}
            </div>
            <div class="font-semibold mb-1">${info.cost}</div>
            <p class="opacity-80">${info.text}</p>
          </div>
        `;
      }).join('');
    }

    function updateSubclass() {
      const subclass = document.getElementById('char-subclass').value;
      characterData.subclass = subclass;
      const featuresDiv = document.getElementById('subclass-features');
      featuresDiv.textContent = subclassFeatures[subclass] || '';
      saveCharacterDebounced();
    }

    // Spell modal
    let targetSpellLevel = 0;
    let editingSpellId = null;

    function openSpellModal() {
      document.getElementById('spell-modal').classList.remove('hidden');
      document.getElementById('spell-modal').classList.add('flex');
    }

    function closeSpellModal() {
      document.getElementById('spell-modal').classList.add('hidden');
      document.getElementById('spell-modal').classList.remove('flex');
      clearSpellModal();
      editingSpellId = null;
    }

    function clearSpellModal() {
      document.getElementById('spell-name-select').value = '';
      document.getElementById('spell-level-input').value = targetSpellLevel;
      document.getElementById('spell-casting-time').value = 'action';
      document.getElementById('spell-range').value = '';
      document.getElementById('spell-duration').value = '';
      document.getElementById('spell-comp-v').checked = false;
      document.getElementById('spell-comp-s').checked = false;
      document.getElementById('spell-comp-m').checked = false;
      document.getElementById('spell-conc').checked = false;
      document.getElementById('spell-effect').value = '';
      document.getElementById('spell-combat-favorite').checked = false;
      document.getElementById('spell-school-display').textContent = '-';
    }

    function editSpell(spellId) {
      const spell = spells.find(s => s.id === spellId);
      if (!spell) return;

      editingSpellId = spellId;
      targetSpellLevel = spell.level;

      document.getElementById('spell-level-input').value = spell.level;
      document.getElementById('delete-spell-btn').style.display = 'block';
      updateSpellList();
      
      setTimeout(() => {
        document.getElementById('spell-name-select').value = spell.name;
        document.getElementById('spell-school-display').textContent = spell.school || '-';
        document.getElementById('spell-casting-time').value = spell.castingTime;
        document.getElementById('spell-range').value = spell.range || '';
        document.getElementById('spell-duration').value = spell.duration || '';
        document.getElementById('spell-comp-v').checked = spell.compV || false;
        document.getElementById('spell-comp-s').checked = spell.compS || false;
        document.getElementById('spell-comp-m').checked = spell.compM || false;
        document.getElementById('spell-conc').checked = spell.concentration || false;
        document.getElementById('spell-effect').value = spell.effect || '';
        document.getElementById('spell-combat-favorite').checked = spell.combatFavorite || false;
      }, 100);

      openSpellModal();
    }

    function updateSpellList() {
      const level = parseInt(document.getElementById('spell-level-input').value);
      const select = document.getElementById('spell-name-select');
      select.innerHTML = '<option value="">Seleccionar hechizo...</option>';
      
      const spellsAtLevel = spellDatabase[level] || [];
      spellsAtLevel.forEach(spell => {
        const option = document.createElement('option');
        option.value = spell.name;
        option.textContent = spell.name;
        select.appendChild(option);
      });
    }

    function autoFillSpell() {
      const level = parseInt(document.getElementById('spell-level-input').value);
      const spellName = document.getElementById('spell-name-select').value;
      
      const spellsAtLevel = spellDatabase[level] || [];
      const spell = spellsAtLevel.find(s => s.name === spellName);
      
      if (spell) {
        document.getElementById('spell-school-display').textContent = spell.school;
      }
    }

    function addSpell(level) {
      targetSpellLevel = level;
      document.getElementById('delete-spell-btn').style.display = 'none';
      openSpellModal();
      document.getElementById('spell-level-input').value = level;
      updateSpellList();
    }

    function saveSpell() {
      const spellName = document.getElementById('spell-name-select').value;
      const level = parseInt(document.getElementById('spell-level-input').value);

      if (!spellName) {
        showToast('Selecciona un hechizo', 'error');
        return;
      }

      const baseId = editingSpellId || Date.now().toString();

      const spell = {
        id: baseId,
        name: spellName,
        level: level,
        castingTime: document.getElementById('spell-casting-time').value,
        range: document.getElementById('spell-range').value,
        duration: document.getElementById('spell-duration').value,
        compV: document.getElementById('spell-comp-v').checked,
        compS: document.getElementById('spell-comp-s').checked,
        compM: document.getElementById('spell-comp-m').checked,
        concentration: document.getElementById('spell-conc').checked,
        effect: document.getElementById('spell-effect').value,
        combatFavorite: document.getElementById('spell-combat-favorite').checked,
        school: document.getElementById('spell-school-display').textContent
      };

      if (editingSpellId) {
        const idx = spells.findIndex(s => s.id === editingSpellId);
        if (idx !== -1) {
          spells[idx] = spell;
          showToast('Hechizo actualizado ‚úì');
        }
      } else {
        spells.push(spell);
        showToast('Hechizo a√±adido ‚úì');
      }

      localStorage.setItem('dnd55_sorcerer_spells', JSON.stringify(spells));
      idbSet('spells', JSON.stringify(spells));
      renderSpells();
      renderCombatSpells();
      updateSpellCounts();
      closeSpellModal();
    }

    function deleteSpellFromModal() {
      if (!editingSpellId) return;

      const spell = spells.find(s => s.id === editingSpellId);
      if (!spell) return;

      spells = spells.filter(s => s.id !== editingSpellId);
      localStorage.setItem('dnd55_sorcerer_spells', JSON.stringify(spells));
      idbSet('spells', JSON.stringify(spells));
      renderSpells();
      renderCombatSpells();
      updateSpellCounts();

      closeSpellModal();
      showToast('Hechizo eliminado');
    }

    function deleteSpell(spellId) {
      const spell = spells.find(s => s.id === spellId);
      if (!spell) return;

      spells = spells.filter(s => s.id !== spellId);
      localStorage.setItem('dnd55_sorcerer_spells', JSON.stringify(spells));
      idbSet('spells', JSON.stringify(spells));
      renderSpells();
      renderCombatSpells();
      updateSpellCounts();
    }

    // Conditions
    function addCondition() {
      const select = document.getElementById('condition-select');
      const condition = select.value;
      if (condition && !characterData.conditions.includes(condition)) {
        characterData.conditions.push(condition);
        renderConditions();
        saveCharacterDebounced();
      }
      select.value = '';
    }

    function removeCondition(condition) {
      characterData.conditions = characterData.conditions.filter(c => c !== condition);
      renderConditions();
      saveCharacterDebounced();
    }

    function renderConditions() {
      const container = document.getElementById('conditions-list');
      container.innerHTML = characterData.conditions.map(c => `
        <span class="px-3 py-1 rounded-full text-sm flex items-center gap-2" style="background: rgba(244, 67, 54, 0.2); border: 1px solid #e57373;">
          ${c}
          <button onclick="removeCondition('${c}')" class="text-red-400 hover:text-red-300 no-print">√ó</button>
        </span>
      `).join('');
    }

    function clearConcentration() {
      document.getElementById('concentration-spell').value = '';
      characterData.concentrationSpell = '';
      saveCharacterDebounced();
    }

    // Rests
    function shortRest() {
      const level = parseInt(document.getElementById('char-level').value) || 1;
      if (level >= 5) {
        // Sorcerous Restoration at level 5+
        const maxPoints = levelData[level - 1].points;
        const currentUsed = characterData.sorceryPointsUsed;
        const restored = Math.min(currentUsed, Math.floor(level / 2));
        characterData.sorceryPointsUsed = Math.max(0, currentUsed - restored);
        renderSorceryPoints(maxPoints);
        showToast(`Restaurados ${restored} puntos de hechicer√≠a`);
      } else {
        showToast('Descanso corto completado');
      }
      saveCharacterDebounced();
    }

    function confirmLongRest() {
      const sure = window.confirm('¬øSeguro que quieres hacer un Descanso Largo? Se restaurar√°n tus recursos y se reiniciar√°n espacios y puntos.');
      if (!sure) return;
      longRest();
    }

    function longRest() {
      const level = parseInt(document.getElementById('char-level').value) || 1;
      
      // Restore HP
      const maxHp = parseInt(document.getElementById('hp-max').value) || 6;
      document.getElementById('hp-current').value = maxHp;
      characterData.hpCurrent = maxHp;
      document.getElementById('hp-temp').value = 0;
      characterData.hpTemp = 0;
      updateHealthBar();
      
      // Restore all spell slots
      characterData.spellSlotsUsed = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };
      
      // Restore sorcery points
      characterData.sorceryPointsUsed = 0;

      // Reset death saves
      characterData.deathSaves = { success: 0, failure: 0 };
      renderDeathSaves();
      
      // Restore inspiration
      hasInspiration = true;
      updateInspirationDisplay();
      
      updateLevel();
      showToast('Descanso largo completado. Todo restaurado.');
      saveCharacterDebounced();
    }

    function updateHealthBar() {
      const maxHp = parseInt(document.getElementById('hp-max').value) || 6;
      const currentHp = parseInt(document.getElementById('hp-current').value) || 0;
      const percentage = Math.max(0, Math.min(100, (currentHp / maxHp) * 100));
      const healthBar = document.getElementById('health-bar');
      
      // Change color based on health percentage
      let barColor = 'linear-gradient(90deg, #81c784 0%, #66bb6a 100%)'; // Green
      if (percentage <= 50 && percentage > 25) {
        barColor = 'linear-gradient(90deg, #ffb74d 0%, #ffa726 100%)'; // Orange
      } else if (percentage <= 25) {
        barColor = 'linear-gradient(90deg, #ef5350 0%, #e53935 100%)'; // Red
      }
      
      healthBar.style.background = barColor;
      healthBar.style.width = percentage + '%';
    }

    function renderDeathSaves() {
      const success = Math.max(0, Math.min(3, characterData.deathSaves?.success ?? 0));
      const failure = Math.max(0, Math.min(3, characterData.deathSaves?.failure ?? 0));

      const successContainer = document.getElementById('death-success-dots');
      const failureContainer = document.getElementById('death-failure-dots');
      if (!successContainer || !failureContainer) return;

      successContainer.querySelectorAll('.death-save-dot').forEach((dot, idx) => {
        dot.classList.remove('success', 'failure');
        if (idx < success) dot.classList.add('success');
      });

      failureContainer.querySelectorAll('.death-save-dot').forEach((dot, idx) => {
        dot.classList.remove('success', 'failure');
        if (idx < failure) dot.classList.add('failure');
      });
    }

    function toggleDeathSave(type, index) {
      if (!characterData.deathSaves) {
        characterData.deathSaves = { success: 0, failure: 0 };
      }

      const current = characterData.deathSaves[type] ?? 0;
      const idx = parseInt(index, 10);

      if (idx < current - 1) {
        characterData.deathSaves[type] = idx + 1;
      } else if (idx === current - 1) {
        characterData.deathSaves[type] = idx;
      } else {
        characterData.deathSaves[type] = Math.min(3, idx + 1);
      }

      if (characterData.deathSaves.success < 0) characterData.deathSaves.success = 0;
      if (characterData.deathSaves.failure < 0) characterData.deathSaves.failure = 0;

      renderDeathSaves();
      saveCharacterDebounced();
    }

    function resetDeathSaves() {
      characterData.deathSaves = { success: 0, failure: 0 };
      renderDeathSaves();
      saveCharacterDebounced();
    }

    function toggleInspiration() {
      hasInspiration = !hasInspiration;
      characterData.hasInspiration = hasInspiration;
      updateInspirationDisplay();
      saveCharacterDebounced();
    }

    function updateInspirationDisplay() {
      const pill = document.getElementById('inspiration-toggle');
      if (!pill) return;
      if (hasInspiration) {
        pill.classList.add('active');
      } else {
        pill.classList.remove('active');
      }
    }

    // ‚îÄ‚îÄ IndexedDB persistence (works on file:// in all mobile browsers) ‚îÄ‚îÄ
    const DB_NAME = 'dnd55_db';
    const DB_VERSION = 1;
    const STORE = 'saves';
    let db = null;

    function openDB() {
      return new Promise((resolve, reject) => {
        if (db) { resolve(db); return; }
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = e => {
          e.target.result.createObjectStore(STORE);
        };
        req.onsuccess = e => { db = e.target.result; resolve(db); };
        req.onerror = () => reject(req.error);
      });
    }

    async function idbSet(key, value) {
      try {
        const database = await openDB();
        return new Promise((resolve, reject) => {
          const tx = database.transaction(STORE, 'readwrite');
          tx.objectStore(STORE).put(value, key);
          tx.oncomplete = resolve;
          tx.onerror = () => reject(tx.error);
        });
      } catch (e) { console.warn('IndexedDB set error', e); }
    }

    async function idbGet(key) {
      try {
        const database = await openDB();
        return new Promise((resolve, reject) => {
          const tx = database.transaction(STORE, 'readonly');
          const req = tx.objectStore(STORE).get(key);
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      } catch (e) { console.warn('IndexedDB get error', e); return null; }
    }

    // Save functions
    let saveTimeout;
    function saveCharacterDebounced() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(saveCharacter, 800);
    }

    function updateCharacterInfo() {
      characterData.name = document.getElementById('char-name').value;
      characterData.class = document.getElementById('char-class').value;
      characterData.race = document.getElementById('char-race').value;
      characterData.background = document.getElementById('char-background').value;
      characterData.alignment = document.getElementById('char-alignment').value;
      characterData.ac = parseInt(document.getElementById('stat-ac').value) || 10;
      characterData.speed = document.getElementById('stat-speed').value;
      characterData.hpMax = parseInt(document.getElementById('hp-max').value) || 6;
      characterData.hpCurrent = parseInt(document.getElementById('hp-current').value) || 6;
      characterData.hpTemp = parseInt(document.getElementById('hp-temp').value) || 0;
      characterData.concentrationSpell = document.getElementById('concentration-spell').value;
      saveCharacterDebounced();
    }

    function saveNotes() {
      characterData.notes = document.getElementById('campaign-notes').value;
      saveCharacterDebounced();
    }

    // ‚îÄ‚îÄ URL Hash persistence (works on iOS Safari file://) ‚îÄ‚îÄ
    function saveToHash() {
      try {
        const state = { c: characterData, s: spells };
        const json = JSON.stringify(state);
        const encoded = btoa(unescape(encodeURIComponent(json)));
        history.replaceState(null, '', '#' + encoded);
        return true;
      } catch(e) {
        console.warn('Hash save failed', e);
        return false;
      }
    }

    function loadFromHash() {
      try {
        const hash = window.location.hash.slice(1);
        if (!hash) return null;
        const json = decodeURIComponent(escape(atob(hash)));
        return JSON.parse(json);
      } catch(e) {
        return null;
      }
    }

    async function saveCharacter() {
      const charValue = JSON.stringify(characterData);
      const spellValue = JSON.stringify(spells);
      // 1. URL hash (iOS Safari ‚Äî guardar como marcador para persistir)
      saveToHash();
      // 2. IndexedDB
      try { await idbSet('character', charValue); await idbSet('spells', spellValue); } catch(e) {}
      // 3. localStorage
      try { localStorage.setItem('dnd55_sorcerer_character', charValue); } catch(e) {}
      try { localStorage.setItem('dnd55_sorcerer_spells', spellValue); } catch(e) {}
      showToast('Guardado ‚úì', 'success');
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast-notification');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast-notification fixed bottom-4 right-4 px-4 py-2 rounded-lg text-sm font-medium z-50 transition-all transform translate-y-0';
      toast.style.background = type === 'success' ? 'rgba(76, 175, 80, 0.9)' : 'rgba(244, 67, 54, 0.9)';
      toast.style.color = 'white';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 2500);
    }

    // ‚îÄ‚îÄ iOS Bookmark helper ‚îÄ‚îÄ
    function updateBookmark() {
      saveToHash();
      showToast('URL actualizada ‚Äî ahora guarda/actualiza el marcador en Safari ‚úì', 'success');
      // Show instructions modal
      const msg = document.createElement('div');
      msg.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px';
      msg.innerHTML = `
        <div style="background:#252033;border:1px solid rgba(157,78,221,0.5);border-radius:16px;padding:24px;max-width:340px;text-align:center;">
          <div style="font-size:2rem;margin-bottom:12px;">üìå</div>
          <div style="font-family:Cinzel,serif;color:#c77dff;font-size:1.1rem;margin-bottom:12px;">Guardar en iOS Safari</div>
          <div style="font-size:0.9rem;opacity:0.85;line-height:1.6;margin-bottom:16px;">
            La URL ya contiene tu personaje actualizado.<br><br>
            <b>Si ya tienes un marcador:</b><br>Ed√≠talo y pega la URL actual.<br><br>
            <b>Si es la primera vez:</b><br>Pulsa el bot√≥n compartir (‚¨ÜÔ∏è) ‚Üí "A√±adir a marcadores" o "A√±adir a pantalla de inicio".
          </div>
          <button onclick="this.closest('div[style*=inset]').remove()" style="background:linear-gradient(135deg,#9d4edd,#5a189a);color:white;border:none;padding:10px 24px;border-radius:8px;font-size:0.95rem;cursor:pointer;">Entendido</button>
        </div>`;
      document.body.appendChild(msg);
    }

    // ‚îÄ‚îÄ Export / Import ‚îÄ‚îÄ
    function exportCharacter() {
      const data = {
        character: characterData,
        spells: spells,
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const name = (characterData.name || 'personaje').replace(/\s+/g, '_');
      a.href = url;
      a.download = `dnd_${name}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Personaje exportado ‚úì', 'success');
    }

    function importCharacter(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async e => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.character) {
            characterData = { ...characterData, ...data.character };
            applyCharacterData();
          }
          if (data.spells) {
            spells = data.spells;
            renderSpells();
            renderCombatSpells();
            updateSpellCounts();
          }
          await saveCharacter();
          showToast('Personaje importado ‚úì', 'success');
        } catch (err) {
          showToast('Error al importar el archivo', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // Initialize on load
    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d05e82e66720331',t:'MTc3MTUwNTYwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>